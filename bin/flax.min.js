PTM_RATIO=32;RADIAN_TO_DEGREE=180/Math.PI;DEGREE_TO_RADIAN=Math.PI/180;IMAGE_TYPES=[".png",".jpg",".bmp",".jpeg",".gif"];SOUND_TYPES=[".mp3",".ogg",".wav",".mp4",".m4a"];DEFAULT_SOUNDS_FOLDER="res/music/";H_ALIGHS=["left","center","right"];var TileValue=TileValue||{WALKABLE:0,BLOCK1:1,BLOCK2:2,BLOCK3:3,BLOCK4:4,BLOCK5:5},flax=flax||{};window.flax=flax;flax.version=1.9;flax.minToolVersion=2;flax.language=null;flax.languageIndex=-1;flax.languages="en zh de fr it es tr pt ru".split(" ");
flax.landscape=!1;flax.osVersion="unknown";flax.assetsManager=null;flax.inputManager=null;flax.currentSceneName="";flax.currentScene=null;flax.buttonSound=null;flax.frameInterval=1/60;flax._scenesDict={};flax._soundEnabled=!0;flax._inited=!1;flax._orientationTip=null;flax._languageDict=null;flax._languageToLoad=null;flax._addResVersion=function(a){return cc.sys.isNative||"string"!=typeof a||flax.isSoundFile(a)||-1<a.indexOf("?v\x3d")?a:a+"?v\x3d"+cc.game.config.version};
flax._removeResVersion=function(a){if(cc.sys.isNative||"string"!=typeof a||flax.isSoundFile(a))return a;var b=a.indexOf("?v\x3d");-1<b&&(a=a.substr(0,b));return a};flax.isDomainAllowed=function(){if(cc.sys.isNative)return!0;var a=document.domain,b=cc.game.config.domainAllowed;return flax.isLocalDebug()||null==b||0==b.length||-1<b.indexOf(a)};flax.isLocalDebug=function(){if(cc.sys.isNative)return!1;var a=document.domain;return"localhost"==a||0==a.indexOf("192.168.")};
if(!cc.sys.isNative&&(flax.isLocalDebug()&&(cc.game.config.version=1+Math.floor(999998*Math.random())),setTimeout(function(){var a=document.body.style.backgroundColor;document.getElementById(cc.game.config.id).style.backgroundColor=a;a=a.replace("rgb(","");a=a.replace(")","");a=a.split(",");flax.bgColor=cc.color(parseInt(a[0]),parseInt(a[1]),parseInt(a[2]))},0.01),cc.sys.isMobile)){var __hideBottomBar=function(){document.body.scrollTop=0},orientationEvent="onorientationchange"in window?"orientationchange":
"resize";window.addEventListener(orientationEvent,__hideBottomBar,!0);__hideBottomBar()}
flax.init=function(a,b){if(!flax._inited){flax._inited=!0;cc.log("Flax inited, version: "+flax.version);null==a&&(a=cc.ResolutionPolicy.SHOW_ALL);flax.fetchUserData&&flax.fetchUserData(b);flax._checkOSVersion();var c=cc.game.config.width,d=cc.game.config.height;if(cc.sys.isNative)cc.view.setDesignResolutionSize(c,d,a);else{var e=document.getElementById(cc.game.config.id);e.width=c=c||e.width;e.height=d=d||e.height;cc.view.adjustViewPort(!0);cc.view.setDesignResolutionSize(c,d,a);cc.view.resizeWithBrowserSize(!0)}flax.frameInterval=
1/cc.game.config.frameRate;flax.assetsManager=flax.AssetsManager.create();c=cc.game.config.language;null==c||""==c?null==flax.language&&(c=cc.sys.language,flax.updateLanguage(c)):flax.updateLanguage(c)}};flax.getLanguageStr=function(a){if(null==flax._languageDict)return cc.log("Warning: there is no language defined: "+flax.language),null;var b=flax._languageDict[a];null==b&&cc.log("Warning: there is no language string for key: "+a);return b};
flax.updateLanguage=function(a){null!=a&&""!=a&&a!=flax.language&&(flax.language=a,cc.game.config.languages&&cc.game.config.languages.length&&(flax.languages=cc.game.config.languages),flax.languageIndex=flax.languages.indexOf(a),-1==flax.languageIndex&&cc.log("Invalid language: "+a),cc.game.config.languageJson&&(flax._languageToLoad=flax._getLanguagePath(a)))};flax._getLanguagePath=function(a){return"res/locale/"+(a||flax.language)+".json"};
flax.addModule=function(a,b,c){if(null==b)throw"Module can not be null!";for(var d in b)if(0==d.indexOf("on")){var e="__"+d,f=e+"Num";void 0===a.prototype[f]?a.prototype[f]=0:a.prototype[f]++;a.prototype[e+a.prototype[f]]=b[d]}else!0!==c&&a.prototype[d]||(a.prototype[d]=b[d])};flax.callModuleFuction=function(a,b,c){b="__"+b;var d=a[b+"Num"];if(void 0!==d)for(;0<=d;)a[b+d](c),d--;else if(a[b])a[b](c)};flax.callModuleOnEnter=function(a){flax.callModuleFuction(a,"onEnter")};
flax.callModuleOnExit=function(a){flax.callModuleFuction(a,"onExit")};flax._checkOSVersion=function(){if(!cc.sys.isNative){var a=navigator.userAgent,b;a.match(/iPad/i)||a.match(/iPhone/i)?(b=a.indexOf("OS "),cc.sys.os=cc.sys.OS_IOS,-1<b&&(flax.osVersion=a.substr(b+3,3).replace("_","."))):a.match(/Android/i)&&(b=a.indexOf("Android "),cc.sys.os=cc.sys.OS_ANDROID,-1<b&&(flax.osVersion=a.substr(b+8,3)))}};
flax.registerScene=function(a,b,c){c||(c=[]);c instanceof Array||(c=[c]);flax._scenesDict[a]={scene:b,res:c}};
flax.replaceScene=function(a,b,c){if(flax.isDomainAllowed()){var d=flax._scenesDict[a];if(null==d)throw"Please register the scene: "+a+" firstly!";flax._languageToLoad&&-1==d.res.indexOf(flax._languageToLoad)&&d.res.push(flax._languageToLoad);if(flax._fontResources)for(var e in flax._fontResources)d.res.push({type:"font",name:e,srcs:flax._fontResources[e]});flax.ObjectPool&&flax.ObjectPool.release();flax.BulletCanvas&&flax.BulletCanvas.release();cc.director.resume();flax.currentSceneName=a;flax.stopPhysicsWorld&&
flax.stopPhysicsWorld();flax.inputManager&&flax.inputManager.removeFromParent();flax.preload(d.res,function(){if(flax._languageToLoad){flax._languageDict=cc.loader.getRes(flax._getLanguagePath());var a=d.res.indexOf(flax._languageToLoad);-1<a&&d.res.splice(a,1);flax._languageToLoad=null}if(flax._fontResources){for(a=d.res.length;a--;)"object"==typeof d.res[a]&&d.res.splice(a,1);flax._fontResources=null}flax.currentScene=new d.scene;a=!1;if(b){if(!c||0>c)c=0.5;var e=b.create(c,flax.currentScene);e&&
(a=!0,cc.director.runScene(e))}a||cc.director.runScene(flax.currentScene);flax.inputManager=new flax.InputManager;flax.currentScene.addChild(flax.inputManager,999999);flax._checkDeviceOrientation()})}};flax.refreshScene=function(){flax.currentSceneName&&flax.replaceScene(flax.currentSceneName)};flax._soundResources={};
flax.preload=function(a,b){if(null!=a&&0!=a.length){for(var c=!1,d=[],e=a.length;e--;){var f=a[e];if(null==f)throw"There is a null resource!";if(null==cc.loader.getRes(f)&&null==flax._soundResources[f])if("string"!=typeof f||".flax"!=cc.path.extname(f)||!cc.sys.isNative&&!1!==cc.game.config.useFlaxRes)c=!0,d.unshift(flax._addResVersion(f));else{cc.sys.isNative&&cc.log("***Warning: .flax is not support JSB for now, use .plist + .png insteadly!");var g=cc.path.changeBasename(f,".plist"),f=cc.path.changeBasename(f,
".png");null==cc.loader.getRes(f)&&(d.unshift(flax._addResVersion(g)),d.unshift(flax._addResVersion(f)),c=!0)}}if(c)return c=flax.nameToObject(cc.game.config.preloader||"flax.Preloader"),c=new c,c.initWithResources(d,function(){if(!cc.sys.isNative)for(var a=d.length;a--;){var c=d[a];flax.isSoundFile(c)&&(flax._soundResources[c]="loaded");var e=cc.loader.getRes(c);if(e){var f=flax._removeResVersion(c);cc.loader.cache[f]=e;flax.isImageFile(f)&&cc.sys.capabilities.opengl&&cc.textureCache.handleLoadedTexture(f);
cc.loader.release(c)}}b()}),cc.director.runScene(c),c}b()};flax.setSoundEnabled=function(a){if(flax._soundEnabled!=a){flax._soundEnabled=a;var b=cc.audioEngine;a?(b.resumeMusic(),flax._lastMusic&&(flax.playMusic(flax._lastMusic,!0),flax._lastMusic=null)):(b.pauseMusic(),b.stopAllEffects())}};flax.getSoundEnabled=function(){return flax._soundEnabled};flax._lastMusic=null;flax.playMusic=function(a,b,c){var d=cc.audioEngine;d.stopMusic(!0===c);flax._soundEnabled?d.playMusic(a,b):flax._lastMusic=a};
flax.stopMusic=function(a){cc.audioEngine.stopMusic(!0===a)};flax.pauseMusic=function(){cc.audioEngine.pauseMusic()};flax.playEffect=function(a){if(flax._soundEnabled)return cc.audioEngine.playEffect(a)};flax.stopEffect=function(a){var b=cc.audioEngine;null!=a?b.stopEffect(a):b.stopAllEffects()};flax.playSound=function(a){return flax.playEffect(a)};
flax._checkDeviceOrientation=function(){if(!cc.sys.isNative){if(!flax._orientationTip&&cc.sys.isMobile&&cc.game.config.rotateImg){flax._orientationTip=cc.LayerColor.create(flax.bgColor,cc.visibleRect.width+10,cc.visibleRect.height+10);var a=cc.Sprite.create(cc.game.config.rotateImg);a.setPosition(cc.visibleRect.center);flax._orientationTip.__icon=a;flax._orientationTip.addChild(a);window.addEventListener("onorientationchange"in window?"orientationchange":"resize",flax._showOrientaionTip,!0);flax._showOrientaionTip()}flax._orientationTip&&
(flax._orientationTip.removeFromParent(),flax.currentScene.addChild(flax._orientationTip,1E6))}};flax._oldGamePauseState=!1;
flax._showOrientaionTip=function(){var a=90==Math.abs(window.orientation);flax._orientationTip.visible=cc.game.config.landscape!=a;flax._orientationTip.__icon.rotation=a?-90:0;document.body.scrollTop=0;flax._orientationTip.visible?(flax.landscape!=a&&(flax._oldGamePauseState=cc.director.isPaused()),cc.director.pause()):flax._oldGamePauseState||cc.director.resume();flax.inputManager.enabled=!flax._orientationTip.visible;flax.landscape=a};
flax.getAngle=function(a,b,c){return flax.getAngle1(b.x-a.x,b.y-a.y,c)};flax.getAngle1=function(a,b,c){void 0===c&&(c=!0);a=Math.atan2(a,b);0>a&&(a+=2*Math.PI);c&&(a*=RADIAN_TO_DEGREE);return a};flax.getPointOnCircle=function(a,b,c){c=(90-c)*DEGREE_TO_RADIAN;null==a&&(a=cc.p());return cc.pAdd(a,cc.p(b*Math.cos(c),b*Math.sin(c)))};flax.getPosition=function(a,b){var c=a.getPosition();!0===b&&a.parent&&(c=a.parent.convertToWorldSpace(c));return c};
flax.getRotation=function(a,b){if(!0!==b)return a.rotation;for(var c=0,d=a;d;)c+=d.rotation,d=d.parent;return c};flax.getScale=function(a,b){if(!0!==b)return cc.p(a.scaleX,a.scaleY);for(var c=1,d=1,e=a;e;)c*=e.scaleX,d*=e.scaleY,e=e.parent;return cc.p(c,d)};
flax.getRect=function(a,b){var c;if(a.getRect)return c=a.getRect(b);if(a instanceof cc.Layer||a instanceof cc.Scene)return cc.rect(0,0,cc.visibleRect.width,cc.visibleRect.height);b=!1!==b;c=a.getPosition();a.parent&&(b?c=a.parent.convertToWorldSpace(c):(c=a.getAnchorPointInPoints(),c=flax.currentScene.convertToNodeSpace(c)));var d=a.getContentSize(),e=a.getAnchorPoint();return c=cc.rect(c.x-d.width*e.x,c.y-d.height*e.y,d.width,d.height)};
flax.ifTouched=function(a,b){if(null==a||!(a instanceof cc.Node))return!1;if(a.mainCollider)return a.mainCollider.containsPoint(b);var c=a.convertToNodeSpace(b),d=flax.getRect(a,!1);return cc.rectContainsPoint(d,c)};flax.ifCollide=function(a,b){return a.mainCollider.checkCollision(b.mainCollider)};flax.isFlaxDisplay=function(a){return a instanceof flax.FlaxSprite||a instanceof flax.FlaxSpriteBatch||a instanceof flax.Image};
flax.isFlaxSprite=function(a){return a instanceof flax.FlaxSprite||a instanceof flax.FlaxSpriteBatch};flax.isMovieClip=function(a){return a instanceof flax.MovieClip||a instanceof flax.MovieClipBatch};flax.isButton=function(a){return a instanceof flax.Button||a instanceof flax.SimpleButton};flax.isChildOf=function(a,b){if(null==a||null==b||a==b)return!1;for(var c=a.parent;c;){if(c==b)return!0;c=c.parent}return!1};
flax.findParentWithClass=function(a,b){for(var c=a;c;){if(c instanceof b)return c;c=c.parent}return null};flax.findChildWithClass=function(a,b){for(var c=a.children,d=c.length,e;d--;)if(e=c[d],e instanceof b||(e=flax.findChildWithClass(e,b)))return e;return null};flax.getUrlVars=function(){var a={};if(cc.sys.isNative)return a;for(var b=window.location.search.substring(1).split("\x26"),c=0;c<b.length;c++){var d=b[c].split("\x3d");a[d[0]]=decodeURIComponent(d[1])}return a};
flax.nameToObject=function(a,b){if(void 0==a||""==a)return null;b=b||"function";for(var c=a.split("."),d=window||this,e=0,f=c.length;e<f;e++)try{d=d[c[e]]}catch(g){break}return typeof d!==b?null:d};flax.createBGLayer=function(a,b){null==b&&(b=cc.color(255,255,255,255));var c=cc.LayerColor.create(b,cc.visibleRect.width,cc.visibleRect.height);a.addChild(c,0);return c};
flax.shuffleArray=function(a,b){if(void 0===b||0>=b||b>a.length)b=a.length;for(var c=b-1;0<=c;c--){var d=0|cc.rand()%(c+1),e=a[c];a[c]=a[d];a[d]=e}};flax.restrictValue=function(a,b,c){a=Math.max(b,a);return a=Math.min(c,a)};flax.numberSign=function(a){return 0==a?0:0<a?1:-1};flax.randInt=function(a,b){return a+Math.floor(Math.random()*(b-a))};flax.getRandomInArray=function(a){if(null==a)return null;var b=flax.randInt(0,a.length);return a[b]};
flax.isImageFile=function(a){if("string"!=typeof a)return!1;a=cc.path.extname(a);return-1<IMAGE_TYPES.indexOf(a)};flax.isSoundFile=function(a){if("string"!=typeof a)return!1;a=cc.path.extname(a);return-1<SOUND_TYPES.indexOf(a)};flax.copyProperties=function(a,b){if(null!=a&&null!=b)for(var c in a)try{b[c]=a[c]}catch(d){}};flax.createDInts=function(a,b){isNaN(b)&&(b=0);for(var c=[],d=-1,e=b-1,f=b;++d<a;)0==d%2?c.push(++e):c.push(--f);return c};flax.homeUrl="http://flax.so";
flax.goHomeUrl=function(){var a=cc.game.config.homeUrl||flax.homeUrl;!cc.sys.isNative&&a&&window.open(a)};function SignalBinding(a,b,c,d,e){this._listener=b;this._isOnce=c;this.context=d;this._signal=a;this._priority=e||0}
SignalBinding.prototype={actived:!0,params:null,execute:function(a){var b;this.actived&&this._listener&&(a=this.params?this.params.concat(a):a,b=this._listener.apply(this.context,a),this._isOnce&&this.detach());return b},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},
_destroy:function(){delete this._signal;delete this._listener;delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", actived:"+this.actived+"]"}};function validateListener(a,b){if("function"!==typeof a)throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",b));}function Signal(){this._bindings=[];this._prevParams=null;var a=this;this.dispatch=function(){Signal.prototype.dispatch.apply(a,arguments)}}
Signal.prototype={VERSION:"::VERSION_NUMBER::",memorize:!1,_shouldPropagate:!0,actived:!0,_registerListener:function(a,b,c,d){var e=this._indexOfListener(a,c);if(-1!==e){if(a=this._bindings[e],a.isOnce()!==b)throw Error("You cannot add"+(b?"":"Once")+"() then add"+(b?"Once":"")+"() the same listener without removing the relationship first.");}else a=new SignalBinding(this,a,b,c,d),this._addBinding(a);this.memorize&&this._prevParams&&a.execute(this._prevParams);return a},_addBinding:function(a){var b=
this._bindings.length;do--b;while(this._bindings[b]&&a._priority<=this._bindings[b]._priority);this._bindings.splice(b+1,0,a)},_indexOfListener:function(a,b){for(var c=this._bindings.length,d;c--;)if(d=this._bindings[c],d._listener===a&&d.context===b)return c;return-1},has:function(a,b){return-1!==this._indexOfListener(a,b)},add:function(a,b,c){validateListener(a,"add");return this._registerListener(a,!1,b,c)},addOnce:function(a,b,c){validateListener(a,"addOnce");return this._registerListener(a,!0,
b,c)},remove:function(a,b){validateListener(a,"remove");var c=this._indexOfListener(a,b);-1!==c&&(this._bindings[c]._destroy(),this._bindings.splice(c,1));return a},removeAll:function(){for(var a=this._bindings.length;a--;)this._bindings[a]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(a){if(this.actived){var b=Array.prototype.slice.call(arguments),c=this._bindings.length,d;this.memorize&&(this._prevParams=
b);if(c){d=this._bindings.slice();this._shouldPropagate=!0;do c--;while(d[c]&&this._shouldPropagate&&!1!==d[c].execute(b))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll();delete this._bindings;delete this._prevParams},toString:function(){return"[Signal active:"+this.actived+" numListeners:"+this.getNumListeners()+"]"}};var signals=Signal;signals.Signal=Signal;(function(a){"function"===typeof define&&define.amd?define(function(){return signals}):"undefined"!==typeof module&&module.exports?module.exports=signals:a.signals=signals})(this);flax.clearDraw=function(){flax.__drawNode&&flax.__drawNode.clear()};flax.drawLine=function(a,b,c,d){flax._createDebugNode();null==c&&(c=1);null==d&&(d=cc.color(255,0,0,255));flax.__drawNode.drawSegment(a,b,c,d)};flax.drawRay=function(a,b,c,d,e){flax.drawLine(a,flax.getPointOnCircle(a,c,b),d,e)};flax.drawRect=function(a,b,c,d){flax._createDebugNode();null==b&&(b=1);null==c&&(c=cc.color(255,0,0,255));var e=cc.pAdd(cc.p(a.x,a.y),cc.p(a.width,a.height));flax.__drawNode.drawRect(cc.p(a.x,a.y),e,d,b,c)};
flax.drawCircle=function(a,b,c,d){flax._createDebugNode();null==c&&(c=1);null==d&&(d=cc.color(255,0,0,255));flax.__drawNode.drawCircle(a,b,360,360,!1,c,d)};flax.drawDot=function(a,b,c){flax._createDebugNode();null==b&&(b=3);null==c&&(c=cc.color(255,0,0,255));flax.__drawNode.drawDot(a,b,c)};
flax._createDebugNode=function(){null==flax.__drawNode&&(flax.__drawNode=cc.DrawNode.create());flax.currentScene&&(flax.__drawNode.parent&&flax.__drawNode.parent!=flax.currentScene&&(flax.__drawNode.removeFromParent(),flax.__drawNode.clear()),null==flax.__drawNode.parent&&flax.currentScene.addChild(flax.__drawNode,99999))};var InputType={press:"onPress",up:"onUp",click:"onClick",move:"onMouseMove",keyPress:"onKeyPress",keyUp:"onKeyUp"};
flax.InputManager=cc.Node.extend({enabled:!0,inTouching:!1,inDragging:!1,justDragged:!1,justDragDist:0,_masks:[],_callbacks:{},_keyboardCallbacks:{},_keyboardListenerCreated:!1,ctor:function(){cc.Node.prototype.ctor.call(this);this._masks=[];this.inTouching=!1;this._callbacks={};this._keyboardCallbacks={};this._keyboardListenerCreated=!1},onEnter:function(){this._super();var a=this,b=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!1,onTouchBegan:function(b,d){if(!a.enabled)return!1;
a.inDragging=!1;a.justDragged=!1;a.justDragDist=0;a.inTouching=!0;a._dispatchOne(a,b,d,InputType.press);return!0},onTouchEnded:function(b,d){a.inDragging=!1;a.inTouching=!1;a._dispatchOne(a,b,d,InputType.up);a._dispatchOne(a,b,d,InputType.click)},onTouchMoved:function(b,d){a.inDragging=!0;a.justDragged=!0;a.justDragDist+=cc.pDistance(cc.p(),b.getDelta());a._dispatchOne(a,b,d,InputType.move)}});cc.eventManager.addListener(b,this)},onExit:function(){this._super();cc.eventManager.removeAllListeners()},
addMask:function(a){-1<this._masks.indexOf(a)||(this._masks.push(a),a.__isInputMask=!0)},removeMask:function(a){var b=this._masks.indexOf(a);-1<b&&(this._masks.splice(b,1),a.__isInputMask=!1)},_compareRealZIndex:function(a,b){if(!a.parent||!b.parent)return 1;if(a.parent==b.parent)return this._childIsOnFront(a,b);for(var c=null,d=0,e=[],f=a.parent;f;)e.push(f),f=f.parent;for(var g=[],f=b.parent;f;){d=e.indexOf(f);if(-1<d){c=f;break}g.push(f);f=f.parent}e=e.slice(0,d);return this._childIsOnFront(e[e.length-
1]||a,g[g.length-1]||b,c)?1:-1},_childIsOnFront:function(a,b,c){null==c&&(c=a.parent);return c.children.indexOf(a)>c.children.indexOf(b)},addListener:function(a,b,c,d){if(null==b)throw"Event callback can not be null!";var e=c==InputType.keyPress||c==InputType.keyUp;null==a&&(a=this,e||cc.log("Listening target is null, make sure you want to listen to the full screen input!"));if(e){e=this._keyboardCallbacks[c];null==e&&(e=[],this._keyboardCallbacks[c]=e);for(var f=e.length;f--;)if(e[f].func==b)return;
e.push({func:b,context:d||a});this._keyboardListenerCreated||this._createKeyboardListener()}else{c=null==c?InputType.click:c;null==a.__instanceId&&(a.__instanceId=ClassManager.getNewInstanceId());e=this._callbacks[a.__instanceId];null==e&&(e=[],this._callbacks[a.__instanceId]=e,a!=this&&this._createListener(a,!0));for(f=e.length;f--;)if(e[f].type==c&&e[f].func==b)return;e.push({type:c,func:b,context:d||a})}},removeListener:function(a,b,c){null==a&&(a=this);var d=this._callbacks[a.__instanceId];if(d&&
(null==c||c!=InputType.keyPress&&c!=InputType.keyUp)){var e=null,f=d.length;if(b||c)for(;f--;)e=d[f],(c&&e.type==c||b&&e.func==b)&&d.splice(f,1);0!=d.length&&(b||c)||delete this._callbacks[a.__instanceId]}if(b&&(null==c||c==InputType.keyPress||c==InputType.keyUp)&&(null==c?(d=this._keyboardCallbacks[InputType.keyPress]||[],d=d.concat(this._keyboardCallbacks[InputType.keyUp]||[])):d=this._keyboardCallbacks[c],d&&d.length))for(f=d.length;f--;)e=d[f],e.func==b&&d.splice(f,1)},removeAllTouchListeners:function(){this._callbacks=
{}},removeAllKeyboardListeners:function(){this._keyboardCallbacks={}},handleTouchBegan:function(a,b){if(!this.enabled)return!1;var c=b.getCurrentTarget();if(this._ifTargetIgnore(c,a))return!1;var d=a.getLocation();if(!this._ifNotMasked(c,d))return!1;b.currentTarget=c;b.target=this._findRealTarget(c,d)||c;if((c instanceof cc.Layer||c instanceof flax.MovieClip)&&b.target==c)return!1;this._dispatch(c,a,b,InputType.press);return!0},handleTouchEnded:function(a,b){var c=b.getCurrentTarget();b.currentTarget=
c;b.target=this._findRealTarget(c,a.getLocation())||c;this._dispatch(c,a,b,InputType.up);flax.ifTouched(c,a.getLocation())&&this._dispatch(c,a,b,InputType.click)},handleTouchMoved:function(a,b){var c=b.getCurrentTarget();this._dispatch(c,a,b,InputType.move)},_createListener:function(a,b){var c=this,d=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:b,onTouchBegan:function(a,b){return c.handleTouchBegan(a,b)},onTouchEnded:function(a,b){c.handleTouchEnded(a,b)},onTouchMoved:function(a,
b){c.handleTouchMoved(a,b)},onTouchCancelled:function(a,b){c.handleTouchEnded(a,b)}});cc.eventManager.addListener(d,a)},_createKeyboardListener:function(){var a=this;cc.eventManager.addListener({event:cc.EventListener.KEYBOARD,onKeyPressed:function(b,c){a._dispatchKeyboardEvent(b,InputType.keyPress)},onKeyReleased:function(b,c){a._dispatchKeyboardEvent(b,InputType.keyUp)}},this);this._keyboardListenerCreated=!0},_ifNotMasked:function(a,b){for(var c=this._masks.length,d=null,d=null;c--;)if(d=this._masks[c],
a!=d&&!flax.isChildOf(a,d)&&!flax.isChildOf(d,a)&&!this._ifTargetIgnore(d)&&1==this._compareRealZIndex(d,a)&&(d=this._findRealTarget(d,b)))return!1;return!0},_findRealTarget:function(a,b){a instanceof Array||(a=[a]);for(var c=null,d=a.length;d--;)if(c=a[d],!this._ifTargetIgnore(c)){if(0<c.children.length&&(this._temp=this._findRealTarget(c.children,b)))return this._temp;if(flax.ifTouched(c,b))return c}return null},_ifTargetIgnore:function(a,b){return null==a||!(a instanceof cc.Scene||a.parent)||!this._ifTargetVisible(a)||
a.isMouseEnabled&&!1===a.isMouseEnabled()||b&&!flax.ifTouched(a,b.getLocation())?!0:!1},_ifTargetVisible:function(a){for(;a;){if(!a.visible)return!1;a=a.parent}return!0},_dispatch:function(a,b,c,d){for(var e=[];a;)e.push(a),a=a.parent;for(var f=0;f<e.length;f++)a=e[f],this._dispatchOne(a,b,c,d)},_dispatchOne:function(a,b,c,d){var e=this._callbacks[a.__instanceId];if(e&&e.length){c.currentTarget=a;a=null;for(var f=[],g=e.length;g--;)a=e[g],a.type==d&&f.push(a);for(g=f.length;g--;)a=f[g],a.func.apply(a.context,
[b,c])}},_dispatchKeyboardEvent:function(a,b){var c=this._keyboardCallbacks[b];if(c&&c.length){for(var d=this._getNativeKeyName(a),e=null,f=[],g=c.length;g--;)e=c[g],f.push(e);for(g=f.length;g--;)e=f[g],e.func.apply(e.context,[d])}},_getNativeKeyName:function(a){var b=Object.getOwnPropertyNames(cc.KEY),c="",d;for(d in b)if(cc.KEY[b[d]]==a){c=b[d];break}return c}});/*
 zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
(function(){function a(a,b){var c=a.split("."),d=g;c[0]in d||!d.execScript||d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||void 0===b?d=d[e]?d[e]:d[e]={}:d[e]=b}function b(a){var b=a.length,c=0,d=Number.POSITIVE_INFINITY,e,f,g,k,l,m,n,p,t;for(p=0;p<b;++p)a[p]>c&&(c=a[p]),a[p]<d&&(d=a[p]);e=1<<c;f=new (h?Uint32Array:Array)(e);g=1;k=0;for(l=2;g<=c;){for(p=0;p<b;++p)if(a[p]===g){m=0;n=k;for(t=0;t<g;++t)m=m<<1|n&1,n>>=1;n=g<<16|p;for(t=m;t<e;t+=l)f[t]=n;++k}++g;k<<=1;l<<=1}return[f,
c,d]}function c(a,b){this.g=[];this.h=32768;this.c=this.f=this.d=this.k=0;this.input=h?new Uint8Array(a):a;this.l=!1;this.i=m;this.q=!1;if(b||!(b={}))b.index&&(this.d=b.index),b.bufferSize&&(this.h=b.bufferSize),b.bufferType&&(this.i=b.bufferType),b.resize&&(this.q=b.resize);switch(this.i){case k:this.a=32768;this.b=new (h?Uint8Array:Array)(32768+this.h+258);break;case m:this.a=0;this.b=new (h?Uint8Array:Array)(this.h);this.e=this.v;this.m=this.s;this.j=this.t;break;default:throw Error("invalid inflate mode");
}}function d(a,b){for(var c=a.f,d=a.c,e=a.input,f=a.d,g=e.length;d<b;){if(f>=g)throw Error("input buffer is broken");c|=e[f++]<<d;d+=8}a.f=c>>>b;a.c=d-b;a.d=f;return c&(1<<b)-1}function e(a,b){for(var c=a.f,d=a.c,e=a.input,f=a.d,g=e.length,h=b[0],k=b[1];d<k&&!(f>=g);)c|=e[f++]<<d,d+=8;e=h[c&(1<<k)-1];g=e>>>16;a.f=c>>g;a.c=d-g;a.d=f;return e&65535}function f(a){function c(a,b,f){var g,h=this.p,k,l;for(l=0;l<a;)switch(g=e(this,b),g){case 16:for(k=3+d(this,2);k--;)f[l++]=h;break;case 17:for(k=3+d(this,
3);k--;)f[l++]=0;h=0;break;case 18:for(k=11+d(this,7);k--;)f[l++]=0;h=0;break;default:h=f[l++]=g}this.p=h;return f}var f=d(a,5)+257,g=d(a,5)+1,k=d(a,4)+4,u=new (h?Uint8Array:Array)(q.length),l;for(l=0;l<k;++l)u[q[l]]=d(a,3);if(!h)for(l=k,k=u.length;l<k;++l)u[q[l]]=0;k=b(u);u=new (h?Uint8Array:Array)(f);l=new (h?Uint8Array:Array)(g);a.p=0;a.j(b(c.call(a,f,k,u)),b(c.call(a,g,k,l)))}var g=this,h="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Uint32Array&&"undefined"!==
typeof DataView,k=0,m=1;c.prototype.u=function(){for(;!this.l;){var a=d(this,3);a&1&&(this.l=!0);a>>>=1;switch(a){case 0:var a=this.input,b=this.d,c=this.b,e=this.a,g=a.length,l=void 0,s=void 0,B=c.length,s=void 0;this.c=this.f=0;if(b+1>=g)throw Error("invalid uncompressed block header: LEN");l=a[b++]|a[b++]<<8;if(b+1>=g)throw Error("invalid uncompressed block header: NLEN");s=a[b++]|a[b++]<<8;if(l===~s)throw Error("invalid uncompressed block header: length verify");if(b+l>a.length)throw Error("input buffer is broken");
switch(this.i){case k:for(;e+l>c.length;){s=B-e;l-=s;if(h)c.set(a.subarray(b,b+s),e),e+=s,b+=s;else for(;s--;)c[e++]=a[b++];this.a=e;c=this.e();e=this.a}break;case m:for(;e+l>c.length;)c=this.e({o:2});break;default:throw Error("invalid inflate mode");}if(h)c.set(a.subarray(b,b+l),e),e+=l,b+=l;else for(;l--;)c[e++]=a[b++];this.d=b;this.a=e;this.b=c;break;case 1:this.j(C,D);break;case 2:f(this);break;default:throw Error("unknown BTYPE: "+a);}}return this.m()};var l=[16,17,18,0,8,7,9,6,10,5,11,4,12,
3,13,2,14,1,15],q=h?new Uint16Array(l):l,l=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],v=h?new Uint16Array(l):l,l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],x=h?new Uint8Array(l):l,l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],z=h?new Uint16Array(l):l,l=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],y=h?new Uint8Array(l):l,l=new (h?Uint8Array:
Array)(288),n,r;n=0;for(r=l.length;n<r;++n)l[n]=143>=n?8:255>=n?9:279>=n?7:8;var C=b(l),l=new (h?Uint8Array:Array)(30);n=0;for(r=l.length;n<r;++n)l[n]=5;var D=b(l);c.prototype.j=function(a,b){var c=this.b,f=this.a;this.n=a;for(var g=c.length-258,h,k,l;256!==(h=e(this,a));)if(256>h)f>=g&&(this.a=f,c=this.e(),f=this.a),c[f++]=h;else for(h-=257,l=v[h],0<x[h]&&(l+=d(this,x[h])),h=e(this,b),k=z[h],0<y[h]&&(k+=d(this,y[h])),f>=g&&(this.a=f,c=this.e(),f=this.a);l--;)c[f]=c[f++-k];for(;8<=this.c;)this.c-=
8,this.d--;this.a=f};c.prototype.t=function(a,b){var c=this.b,f=this.a;this.n=a;for(var g=c.length,h,k,l;256!==(h=e(this,a));)if(256>h)f>=g&&(c=this.e(),g=c.length),c[f++]=h;else for(h-=257,l=v[h],0<x[h]&&(l+=d(this,x[h])),h=e(this,b),k=z[h],0<y[h]&&(k+=d(this,y[h])),f+l>g&&(c=this.e(),g=c.length);l--;)c[f]=c[f++-k];for(;8<=this.c;)this.c-=8,this.d--;this.a=f};c.prototype.e=function(){var a=new (h?Uint8Array:Array)(this.a-32768),b=this.a-32768,c,d,e=this.b;if(h)a.set(e.subarray(32768,a.length));else for(c=
0,d=a.length;c<d;++c)a[c]=e[c+32768];this.g.push(a);this.k+=a.length;if(h)e.set(e.subarray(b,b+32768));else for(c=0;32768>c;++c)e[c]=e[b+c];this.a=32768;return e};c.prototype.v=function(a){var b,c=this.input.length/this.d+1|0,d,e,f,g=this.input,k=this.b;a&&("number"===typeof a.o&&(c=a.o),"number"===typeof a.r&&(c+=a.r));2>c?(d=(g.length-this.d)/this.n[2],f=d/2*258|0,e=f<k.length?k.length+f:k.length<<1):e=k.length*c;h?(b=new Uint8Array(e),b.set(k)):b=k;return this.b=b};c.prototype.m=function(){var a=
0,b=this.b,c=this.g,d,e=new (h?Uint8Array:Array)(this.k+(this.a-32768)),f,g,k,l;if(0===c.length)return h?this.b.subarray(32768,this.a):this.b.slice(32768,this.a);f=0;for(g=c.length;f<g;++f)for(d=c[f],k=0,l=d.length;k<l;++k)e[a++]=d[k];f=32768;for(g=this.a;f<g;++f)e[a++]=b[f];this.g=[];return this.buffer=e};c.prototype.s=function(){var a,b=this.a;h?this.q?(a=new Uint8Array(b),a.set(this.b.subarray(0,b))):a=this.b.subarray(0,b):(this.b.length>b&&(this.b.length=b),a=this.b);return this.buffer=a};a("Zlib.RawInflate",
c);a("Zlib.RawInflate.prototype.decompress",c.prototype.u);var l={ADAPTIVE:m,BLOCK:k},w,A;if(Object.keys)n=Object.keys(l);else for(w in n=[],r=0,l)n[r++]=w;r=0;for(A=n.length;r<A;++r)w=n[r],a("Zlib.RawInflate.BufferType."+w,l[w])}).call(this);
flax._flaxLoader={load:function(a,b,c,d){cc.loader.loadBinary(a,function(b,c){a=flax._removeResVersion(a);for(var g=(new Zlib.RawInflate(c)).decompress(),h="",k=g.length,m=0;m<k;m++)h+=String.fromCharCode(g[m]);c=h.split("data:image/gif;base64,");h=cc.path.changeBasename(a,".plist");g=cc.path.changeBasename(a,".png");cc.loader.cache[h]=JSON.parse(c[0]);h=new Image;h.src="data:image/gif;base64,"+c[1];cc.loader.cache[g]=h;cc.textureCache.handleLoadedTexture(g);flax.assetsManager.addAssets(a);b?d(b):
d(null,"Not reachable!");cc.loader.release(a);cc.loader.cache[a]="loaded!"})}};cc.sys.isNative||cc.loader.register(["flax"],flax._flaxLoader);flax._assetsClassMap={btn:"flax.SimpleButton",button:"flax.SimpleButton",progress:"flax.ProgressBar",jpg:"flax.Image",png:"flax.Image",scrollPane:"flax.ScrollPane",gun:"flax.Gunner"};flax._assetsMcClassMap={button:"flax.Button",scrollPane:"flax.MCScrollPane",gun:"flax.MCGunner",gun1:"flax.MCGunner"};flax.ASSET_NONE=0;flax.ASSET_ANIMATOR=1;flax.ASSET_MOVIE_CLIP=2;flax.ASSET_IMAGE=3;flax.registerClass=function(a,b){flax._assetsClassMap[a]=b};
flax.registerMcClass=function(a,b){flax._assetsMcClassMap[a]=b};
flax.AssetsManager=cc.Class.extend({framesCache:null,displaysCache:null,displayDefineCache:null,mcsCache:null,subAnimsCache:null,fontsCache:null,init:function(){this.framesCache={};this.displaysCache={};this.displayDefineCache={};this.mcsCache={};this.subAnimsCache={};this.fontsCache={}},getAssetType:function(a,b){if(this.getMc(a,b))return flax.ASSET_MOVIE_CLIP;var c=this.getDisplayDefine(a,b);return c?"jpg"==c.type||"png"==c.type?flax.ASSET_IMAGE:"share"==c.type?this.getAssetType(this._getSharedPlist(a,
c),b):flax.ASSET_ANIMATOR:flax.ASSET_NONE},createDisplay:function(a,b,c,d,e){if(null==a||null==b)throw"Pleas give me assetsFile and assetID!";null==e&&c&&(e=c["class"]);if(c&&"string"===typeof c||e&&"string"!==typeof e)throw"Params error: maybe you are using the old api, please use the latest!";this.addAssets(a);var f=this.getSubAnims(a,b);f.length&&(b=b+"$"+f[0]);var g=this.getDisplayDefine(a,b);if(g&&"share"==g.type)return this.createDisplay(this._getSharedPlist(a,g),b,c,d,e);f=null;if(e&&(f=flax.nameToObject(e),
null==f))throw"The class: "+e+" doesn't exist!";if(null==f){var h=!1;null==g&&(g=this.getMc(a,b),h=!0);if(g)e=g.type,"null"==e&&"jpg"!=b&&"png"!=b&&(e=b),f=flax.nameToObject(e),null==f&&(e=h?flax._assetsMcClassMap[e]:flax._assetsClassMap[e],f=flax.nameToObject(e)),null==f&&(f=h?flax.MovieClip:flax.Animator,e=h?"flax.MovieClip":"flax.Animator",h&&c&&!0===c.batch&&(f=flax.MovieClipBatch,e="flax.MovieClipBatch"));else throw"There is no display with assetID: "+b+" in assets file: "+a+", or make sure the display is not a BLANK symbol!";
}null==c&&(c={});g=null;h=c.parent;delete c.parent;!0===d?g=flax.ObjectPool.get(a,e,b).fetch(b,h,c):(g=f.create?f.create(a,b):new f(a,b),g.attr(c),h&&h.addChild(g),g.clsName=e);return g},cloneDisplay:function(a,b,c){if(!flax.isFlaxDisplay(a))throw"cloneDisplay only support flax type display!";b=this.createDisplay(a.assetsFile,a.assetID,{parent:c?a.parent:null},b,a.clsName);c&&b.setPosition(a.getPosition());b.setScale(a.getScale());b.setRotation(a.rotation);b.zIndex=a.zIndex;return b},addAssets:function(a){if("undefined"!==
typeof this.framesCache[a])return!1;var b=a;".flax"==cc.path.extname(a)&&(b=cc.path.changeBasename(b,".plist"));var c=cc.loader.getRes(b);if(null==c)throw"Make sure you have pre-loaded the resource: "+a;if(!c.metadata.flaxVersion||c.metadata.flaxVersion<flax.minToolVersion)throw"The resource: "+a+" was exported with the old version of Flax, please do it with current version!";var d=c.metadata.fps;cc.spriteFrameCache.addSpriteFrames(b);cc.loader.cache[b]="loaded!";var b=[],e=c.frames,f;for(f in e)b.push(f);
b.sort();this.framesCache[a]=b;c.displays&&this._parseDisplays(a,c.displays,d);c.mcs&&this._parseMovieClips(a,c.mcs,d);c.fonts&&this._parseFonts(a,c.fonts);return!0},_parseDisplays:function(a,b,c){var d=[],e=null,f;for(f in b)d.push(f),e=b[f],e.anchors&&(e.anchors=this._parseFrames(e.anchors)),e.colliders&&(e.colliders=this._parseFrames(e.colliders)),e.fps=c||cc.game.config.frameRate,this.displayDefineCache[a+f]=e,this._parseSubAnims(a,f);this.displaysCache[a]=d},_parseMovieClips:function(a,b,c){for(var d in b){var e=
b[d];e.anchors&&(e.anchors=this._parseFrames(e.anchors));e.colliders&&(e.colliders=this._parseFrames(e.colliders));var f,g=e.children,h;for(h in g)f=g[h],f.frames=this._strToArray(f.frames);e.fps=c||cc.game.config.frameRate;this.mcsCache[a+d]=e;this._parseSubAnims(a,d)}},_parseFonts:function(a,b){for(var c in b)this.fontsCache[a+c]=b[c]},_parseSubAnims:function(a,b){var c=b.split("$"),d=c[0],c=c[1];if(d&&c&&""!=d&&""!=c){var d=a+d,e=this.subAnimsCache[d];null==e&&(e=[],this.subAnimsCache[d]=e);e.push(c)}},
_parseFrames:function(a){var b={},c;for(c in a)b[c]=this._strToArray(a[c]);return b},_strToArray:function(a){a=a.split("|");for(var b=-1,c=[];++b<a.length;){var d=a[b];"null"===d?c.push(null):""===d?c.push(c[b-1]):c.push(d)}return c},_getSharedPlist:function(a,b){return a.slice(0,a.indexOf("/"))+"/"+b.url+".plist"},getFrameNames:function(a,b,c){this.addAssets(a);a=this.framesCache[a];if(null==a)return[];-1==b&&(b=0);-1==c&&(c=a.length-1);return a.slice(parseInt(b),parseInt(c)+1)},getFrameNamesOfDisplay:function(a,
b){var c=this.getDisplayDefine(a,b);if(null==c)throw"There is no display named: "+b+" in assetsFile: "+a;return this.getFrameNames(a,c.start,c.end)},getDisplayDefine:function(a,b){this.addAssets(a);return this.displayDefineCache[a+b]},getDisplayNames:function(a){this.addAssets(a);return this.displaysCache[a]||[]},getRandomDisplayName:function(a){a=this.getDisplayNames(a);var b=Math.floor(Math.random()*a.length);return a[b]},getMc:function(a,b){this.addAssets(a);return this.mcsCache[a+b]},getSubAnims:function(a,
b){this.addAssets(a);return this.subAnimsCache[a+b]||[]},getFont:function(a,b){this.addAssets(a);return this.fontsCache[a+b]}});flax.AssetsManager.create=function(){var a=new flax.AssetsManager;a.init();return a};flax.ColliderType={rect:"Rect",circle:"Circle",polygon:"Poly"};
flax.Collider=cc.Class.extend({name:null,owner:null,type:flax.ColliderType.rect,physicsBody:null,physicsFixture:null,physicsContact:null,_center:null,_width:0,_height:0,_rotation:0,_localRect:null,_polygons:null,ctor:function(a,b){a=a.split(",");this.type=a[0];this._center=cc.p(parseFloat(a[1]),parseFloat(a[2]));this._width=parseFloat(a[3]);this._height=parseFloat(a[4]);this._rotation=parseFloat(a[5]);if(6<a.length){this._polygons=[];for(var c=a[6].split("'"),d=0;d<c.length-1;d+=2){var e=cc.p(parseFloat(c[d]),
parseFloat(c[d+1]));this._polygons.push(e)}}!1===b&&(this._center.x+=this._width/2,this._center.y+=this._height/2);this._localRect=cc.rect(this._center.x-this._width/2,this._center.y-this._height/2,this._width,this._height)},createPhysics:function(a,b,c,d,e,f){if(this.physicsFixture)return this.physicsFixture;var g=this.physicsBody=this.owner.physicsBody;if(null==g)throw"Please CreatePhysics in its owner firstly!";var h=this.getSize(),k=this.getCenter(),m=flax.getPosition(this.owner,!0),l=null;if(this.type==
flax.ColliderType.circle)l=new Box2D.Collision.Shapes.b2CircleShape,l.SetRadius(0.5*h.width*flax.getScale(this.owner,!0).x/PTM_RATIO),m=cc.pSub(k,m),l.SetLocalPosition(cc.pMult(m,1/PTM_RATIO));else if(this.type==flax.ColliderType.rect||this.type==flax.ColliderType.polygon){if(this.type==flax.ColliderType.rect)for(this._polygons=[cc.p(-0.5*h.width,-0.5*h.height),cc.p(0.5*h.width,-0.5*h.height),cc.p(0.5*h.width,0.5*h.height),cc.p(-0.5*h.width,0.5*h.height)],h=0;h<this._polygons.length;h++)k=this._polygons[h],
k.x+=this._center.x,k.y+=this._center.y;for(var l=new Box2D.Collision.Shapes.b2PolygonShape,q=[],h=0;h<this._polygons.length;h++)k=cc.p(this._polygons[h]),k=this.owner.convertToWorldSpace(k),k.x-=m.x,k.y-=m.y,k.x/=PTM_RATIO,k.y/=PTM_RATIO,q.push(k);l.SetAsArray(q)}else throw"The physics type: "+this.type+" is not supported!";m=new Box2D.Dynamics.b2FixtureDef;m.shape=l;null==a&&(a=0);m.density=a;null==b&&(b=0.2);m.friction=b;null==c&&(c=0);m.restitution=c;m.isSensor=d;null==e&&(e=1);null==f&&(f=65535);
m.filter.categoryBits=e;m.filter.maskBits=f;this.physicsFixture=g.CreateFixture(m);this.physicsFixture.SetUserData(this);return this.physicsFixture},destroyPhysics:function(){this.physicsFixture&&(flax.removePhysicsFixture(this.physicsFixture),this.physicsBody=this.physicsFixture=null)},checkCollision:function(a){if(a.type==this.type&&this.type==flax.ColliderType.rect)return cc.rectIntersectsRect(this.getRect(!0),a.getRect(!0));if(a.type==this.type&&this.type==flax.ColliderType.circle){var b=this.getCenter(!0),
c=a.getCenter(!0);return cc.pDistance(b,c)<=(this.getSize().width+a.getSize().width)/2}if(this.type==flax.ColliderType.rect)return this._ifRectCollidCircle(this.getRect(!0),a.getRect(!0));if(this.type==flax.ColliderType.circle)return this._ifRectCollidCircle(a.getRect(!0),this.getRect(!0))},containPoint:function(a){return this.containsPoint(a)},containsPoint:function(a){a=this.owner.convertToNodeSpace(a);return this.type==flax.ColliderType.rect?cc.rectContainsPoint(this._localRect,a):this.type==flax.ColliderType.polygon?
this._polyContainsPoint(a):cc.pDistance(a,this._center)<=this._width/2},_polyContainsPoint:function(a){for(var b=!1,c=this._polygons.length,d=0,e=c-1;d<c;e=d++){var f=this._polygons[d],e=this._polygons[e];(intersect=f.y>a.y!==e.y>a.y&&a.x<(e.x-f.x)*(a.y-f.y)/(e.y-f.y)+f.x)&&(b=!b)}return b},_ifRectCollidCircle:function(a,b){var c=Math.abs(b.x+b.width/2-(a.x+a.width/2)),d=Math.abs(b.y+b.height/2-(a.y+a.height/2));if(c>a.width/2+b.width/2||d>a.height/2+b.width/2)return!1;if(c<=a.width/2||d<=a.height/
2)return!0;c-=a.width/2;d-=a.height/2;return c*c+d*d<=b.width/2*b.width/2},getRect:function(a){if(!1===a)return this._localRect;a=this.getCenter(!0);var b=this.getSize();return cc.rect(a.x-b.width/2,a.y-b.height/2,b.width,b.height)},getCenter:function(a){var b=this.owner.convertToWorldSpace(this._center);!1===a&&this.owner.parent&&(b=this.owner.parent.convertToNodeSpace(b));return b},getSize:function(){var a=flax.getScale(this.owner,!0),b=this._width*Math.abs(a.x),a=this._height*Math.abs(a.y);return{width:b,
height:a}},debugDraw:function(){var a=this.getRect(!0);if(this.type==flax.ColliderType.rect)flax.drawRect(a);else{var b=cc.DrawNode.create();flax.currentScene&&flax.currentScene.addChild(b,99999);var c=cc.color(255,0,0,255),d=cc.color(0,255,0,122);if(this.type==flax.ColliderType.circle)b.drawCircle(this.getCenter(!0),a.width/2,0,360,!1,1,c,d);else{for(var e=a=null,f=null,g=0;g<this._polygons.length-1;g++)e=cc.p(this._polygons[g]),e=this.owner.convertToWorldSpace(e),0==g&&(a=cc.p(e)),f=cc.p(this._polygons[g+
1]),f=this.owner.convertToWorldSpace(f),b.drawSegment(e,f,1,c,d);b.drawSegment(f,a,1,c,d)}}}});flax.onCollideStart=new signals.Signal;flax.onCollideEnd=new signals.Signal;flax.onCollidePre=new signals.Signal;flax.onCollidePost=new signals.Signal;flax._physicsWorld=null;flax._physicsListener=null;flax._physicsRunning=!1;flax._physicsBodyToRemove=null;flax._physicsFixtureToRemove=null;flax.physicsTypeStatic=0;flax.physicsTypeKinematic=1;flax.physicsTypeDynamic=2;flax.physicsWorldPos=cc.p();
flax.createPhysicsWorld=function(a,b){flax._physicsWorld&&flax.destroyPhysicsWorld();var c=new Box2D.Dynamics.b2World(new Box2D.Common.Math.b2Vec2(a.x,a.y),!0===b);c.SetContinuousPhysics(!0);flax.physicsWorldPos=cc.p();flax._physicsWorld=c;flax._physicsBodyToRemove=[];flax._physicsFixtureToRemove=[];return c};flax.getPhysicsWorld=function(){if(null==flax._physicsWorld)throw"Pleas use flax.createPhysicsWorld to create the world firstly!";return flax._physicsWorld};
flax.startPhysicsWorld=function(){flax.getPhysicsWorld()&&flax.currentScene&&!flax._physicsRunning&&(flax._createPhysicsListener(),flax.currentScene.schedule(flax._updatePhysicsWorld,1/cc.game.config.frameRate),flax._physicsRunning=!0)};flax.stopPhysicsWorld=function(){flax._physicsRunning&&flax.currentScene&&(flax.currentScene.unschedule(flax._updatePhysicsWorld),flax._physicsRunning=!1)};
flax.destroyPhysicsWorld=function(){if(flax._physicsWorld){flax.stopPhysicsWorld();for(var a=flax._physicsWorld.GetBodyList();a;a=a.GetNext()){var b=a.GetUserData();b&&(b._physicsBody=null);flax._physicsWorld.DestroyBody(a)}flax.onCollideStart.removeAll();flax.onCollideEnd.removeAll();flax.onCollidePre.removeAll();flax.onCollidePost.removeAll();flax._physicsWorld=null;flax._physicsListener=null;flax._physicsBodyToRemove=null}};
flax.removePhysicsBody=function(a){-1==flax._physicsBodyToRemove.indexOf(a)&&flax._physicsBodyToRemove.push(a)};flax.removePhysicsFixture=function(a){-1==flax._physicsFixtureToRemove.indexOf(a)&&flax._physicsFixtureToRemove.push(a)};
flax.physicsRaycast=function(a,b,c,d){flax.getPhysicsWorld().RayCast(function(e,f,g,h){e=e.GetUserData();f=cc.pMult(f,PTM_RATIO);var k=cc.pSub(c,f);g=cc.pMult(g,cc.pDot(k,g));k=cc.pSub(c,cc.pMult(g,2));g=flax.getAngle(f,k);d&&0<d&&(h=flax.getAngle(b,c),d/=Math.sin(Math.abs(g/2-h/2)*Math.PI/180),f=cc.pSub(f,flax.getPointOnCircle(cc.p(),d,h)),k=cc.pDistance(b,c),h=cc.pDistance(b,f)/k,k=flax.getPointOnCircle(f,k*(1-h),g));a(e,f,k,h)},cc.pMult(b,1/PTM_RATIO),cc.pMult(c,1/PTM_RATIO))};
flax.physicsSimulate=function(a,b,c){c||(c=flax.frameInterval);b=Math.round(b/c);for(var d=a.GetPosition(),e=a.GetAngle(),f={},g=0,h=flax._physicsWorld.GetBodyList();h;h=h.GetNext())if(h!=a){var k=h.GetType();k!=flax.physicsTypeStatic&&(h.m_type=flax.physicsTypeStatic,h.__tempKey=++g,f[h.__tempKey]=k)}k=[];for(g=0;g<b;g++)flax._physicsWorld.Step(c,velocityIterations,positionIterations),h=a.GetPosition(),k.push(cc.p(h.x*PTM_RATIO,h.y*PTM_RATIO));for(h=flax._physicsWorld.GetBodyList();h;h=h.GetNext())h.__tempKey&&
(h.SetType(f[h.__tempKey]),delete h.__tempKey);a.SetPositionAndAngle(d,e);return k};
flax._createPhysicsListener=function(){flax._physicsListener||(flax._physicsListener=new Box2D.Dynamics.b2ContactListener,flax._physicsListener.BeginContact=function(a){var b=a.GetFixtureA(),c=a.GetFixtureB(),b=b.GetUserData()||b,c=c.GetUserData()||c;b.owner&&null==b.owner.parent||c.owner&&null==c.owner.parent||(b.physicsContact=c.physicsContact=a,flax.onCollideStart.dispatch(b,c),b.physicsContact=c.physicsContact=null)},flax._physicsListener.EndContact=function(a){var b=a.GetFixtureA(),c=a.GetFixtureB(),
b=b.GetUserData()||b,c=c.GetUserData()||c;b.owner&&null==b.owner.parent||c.owner&&null==c.owner.parent||(b.physicsContact=c.physicsContact=a,flax.onCollideEnd.dispatch(b,c),b.physicsContact=c.physicsContact=null)},flax._physicsListener.PreSolve=function(a,b){var c=a.GetFixtureA(),d=a.GetFixtureB(),c=c.GetUserData()||c,d=d.GetUserData()||d;c.owner&&null==c.owner.parent||d.owner&&null==d.owner.parent||(c.physicsContact=d.physicsContact=a,flax.onCollidePre.dispatch(c,d),c.physicsContact=d.physicsContact=
null)},flax._physicsListener.PostSolve=function(a,b){var c=a.GetFixtureA(),d=a.GetFixtureB(),c=c.GetUserData()||c,d=d.GetUserData()||d;c.owner&&null==c.owner.parent||d.owner&&null==d.owner.parent||(c.physicsContact=d.physicsContact=a,flax.onCollidePost.dispatch(c,d),c.physicsContact=d.physicsContact=null)},flax._physicsWorld.SetContactListener(flax._physicsListener))};
flax.createPhysicalWalls=function(a,b){if(null==a||0==a.length)a=[1,1,1,1];var c=flax.getPhysicsWorld(),d=new Box2D.Dynamics.b2FixtureDef;d.density=1;null==b&&(b=3);d.friction=b;var e=new Box2D.Dynamics.b2BodyDef,f=cc.director.getWinSize();e.type=Box2D.Dynamics.b2Body.b2_staticBody;d.shape=new Box2D.Collision.Shapes.b2PolygonShape;d.shape.SetAsBox(0.5*f.width/PTM_RATIO,0.5);a[0]&&(e.position.Set(0.5*f.width/PTM_RATIO,f.height/PTM_RATIO),c.CreateBody(e).CreateFixture(d));a[1]&&(e.position.Set(0.5*
f.width/PTM_RATIO,0),c.CreateBody(e).CreateFixture(d));d.shape.SetAsBox(0.5,0.5*f.height/PTM_RATIO);a[2]&&(e.position.Set(0,0.5*f.height/PTM_RATIO),c.CreateBody(e).CreateFixture(d));a[3]&&(e.position.Set(f.width/PTM_RATIO,0.5*f.height/PTM_RATIO),c.CreateBody(e).CreateFixture(d))};var velocityIterations=8,positionIterations=1;
flax._updatePhysicsWorld=function(a){for(var b=flax._physicsFixtureToRemove.length;b--;){var c=flax._physicsFixtureToRemove[b],d=c.GetBody();d&&d.DestroyFixture(c);flax._physicsFixtureToRemove.splice(b,1)}for(b=flax._physicsBodyToRemove.length;b--;)flax._physicsWorld.DestroyBody(flax._physicsBodyToRemove[b]),flax._physicsBodyToRemove.splice(b,1);flax._physicsWorld.Step(a,velocityIterations,positionIterations);for(a=flax._physicsWorld.GetBodyList();a;a=a.GetNext())b=a.GetUserData(),null!=b&&null!=
b&&b.parent&&(c=cc.p(a.GetPosition()),c.x*=PTM_RATIO,c.y*=PTM_RATIO,c=cc.pAdd(c,flax.physicsWorldPos),c=b.parent.convertToNodeSpace(c),b.x=c.x,b.y=c.y,!0!==b.ignoreBodyRotation&&(b.rotation=-1*RADIAN_TO_DEGREE*a.GetAngle(),b.rotation+=a.__rotationOffset))};flax._debugBox2DNode=null;flax.debugDrawPhysics=function(){null==flax._debugBox2DNode&&(flax._debugBox2DNode=new flax.DebugBox2DNode(flax.getPhysicsWorld()),flax.currentScene.addChild(flax._debugBox2DNode,Number.MAX_VALUE))};
flax.DebugBox2DNode=cc.Node.extend({_refWorld:null,ctor:function(a){this._super();this._refWorld=a;a=Box2D.Dynamics.b2DebugDraw;var b=new a;b.SetSprite(document.getElementById("gameCanvas").getContext("2d"));var c=PTM_RATIO*cc.view.getViewPortRect().width/cc.view.getDesignResolutionSize().width;b.SetDrawScale(c);b.SetFillAlpha(0.5);b.SetLineThickness(1);b.SetFlags(a.e_shapeBit|a.e_jointBit|a.e_centerOfMassBit);this._refWorld.SetDebugDraw(b)},draw:function(a){this._super();this._refWorld&&(a.scale(1,
-1),this._refWorld.DrawDebugData(),a.scale(1,1),a.translate(0,0))}});flax.TileMapModule={tx:0,ty:0,autoUpdateTileWhenMove:!0,tileValue:TileValue.WALKABLE,_tileMap:null,_tileInited:!1,onEnter:function(){this._tileMap&&!this._tileInited&&this.updateTile(!0)},onExit:function(){this._tileMap&&this._tileMap.removeObject(this);this._tileMap=null;this._tileInited=!1},onPosition:function(){this.autoUpdateTileWhenMove&&this._tileMap&&this.updateTile()},getTileMap:function(){return this._tileMap},setTileMap:function(a){!a||a instanceof flax.TileMap||(a=flax.getTileMap(a));this._tileMap!=
a&&(this._tileMap&&this._tileMap.removeObject(this),this._tileMap=a,null!=this._tileMap&&this.parent&&this.updateTile(!0))},updateTile:function(a){if(this._tileMap){var b=this.getPosition();this.parent&&(b=this.parent.convertToWorldSpace(b));b=this._tileMap.getTileIndex(b);this.setTile(b.x,b.y,a)}},setTile:function(a,b,c){if(!0===c||a!=this.tx||b!=this.ty){c=this.tx;var d=this.ty;this.tx=a;this.ty=b;this._tileMap&&this.parent&&(this._tileMap.removeObject(this,c,d),this.parent&&(this._tileMap.addObject(this),
this._tileInited=!0))}}};flax.Anchor=cc.Class.extend({x:0,y:0,zIndex:0,rotation:0,ctor:function(a){a=a.split(",");this.x=parseFloat(a[0]);this.y=parseFloat(a[1]);2<a.length&&(this.zIndex=parseInt(a[2]));3<a.length&&(this.rotation=parseFloat(a[3]))}});
flax._sprite={__instanceId:null,onAnimationOver:null,onSequenceOver:null,onFrameChanged:null,onFrameLabel:null,autoDestroyWhenOver:!1,autoStopWhenOver:!1,autoHideWhenOver:!1,autoRecycle:!1,currentFrame:0,currentAnim:null,totalFrames:0,frameInterval:0,ignoreBodyRotation:!1,define:null,name:null,assetsFile:null,assetID:null,clsName:"flax.FlaxSprite",playing:!1,_prevFrame:-1,_labelFrames:null,_labelSounds:null,_loopStart:0,_loopEnd:0,_isLanguageElement:!1,__isFlaxSprite:!0,__isInputMask:!1,_fps:24,_colliders:null,
_mainCollider:null,_physicsBody:null,_definedMainCollider:!1,_anchorBindings:null,_inited:!1,_mouseEnabled:!0,_baseAssetID:null,_subAnims:null,_animSequence:null,_loopSequence:!1,_sequenceIndex:0,_physicsToBeSet:null,_physicsBodyParam:null,_physicsColliders:null,ctor:function(a,b){if("flax.FlaxSprite"==this.clsName)throw"flax.FlaxSprite is an abstract class, please use flax.Animator or flax.MovieClip!";this instanceof cc.SpriteBatchNode?cc.SpriteBatchNode.prototype.ctor.call(this,cc.path.changeExtname(a,
".png")):cc.Sprite.prototype.ctor.call(this);if(!a||!b)throw"Please set assetsFile and assetID to me!";this.__instanceId=ClassManager.getNewInstanceId();this._anchorBindings=[];this._animSequence=[];this.onAnimationOver=new signals.Signal;this.onSequenceOver=new signals.Signal;this.onFrameChanged=new signals.Signal;this.onFrameLabel=new signals.Signal;this.setSource(a,b)},setSource:function(a,b){if(null==a||null==b)throw"assetsFile and assetID can not be null!";if(this.assetsFile!=a||this.assetID!=
b&&this._baseAssetID!=b){this.assetsFile=a;this.currentAnim=null;this.assetID=this._handleSumAnims(b);this.define=this.getDefine();var c=this.define.anchorX,d=this.define.anchorY;isNaN(c)||isNaN(d)||this.setAnchorPoint(c,d);0==this.fps&&(this.fps=this.define.fps);this.onNewSource();this.currentFrame=0;this._initFrameLabels();this.renderFrame(this.currentFrame,!0);this._initColliders();this.parent&&this._updateLaguage();null==this.__pool__id__&&(this.__pool__id__=this.assetID);this.currentAnim&&this.onFrameLabel.dispatch(this.currentAnim)}},
_handleSumAnims:function(a){a=a.split("$");this._baseAssetID=a[0];this._subAnims=flax.assetsManager.getSubAnims(this.assetsFile,this._baseAssetID);var b=a[1];null==b&&this._subAnims&&(b=this._subAnims[0]);a=this._baseAssetID;b&&(a=this._baseAssetID+"$"+b,this.currentAnim=b);return a},_initFrameLabels:function(){this._labelFrames=[];this._frameSounds={};var a=this.define.labels;if(a){for(var b in a){var c=a[b];-1<b.indexOf("@")?(null==this.define.sounds&&(this.define.sounds={}),this.define.sounds[""+
c.start]=DEFAULT_SOUNDS_FOLDER+b.slice(0,b.indexOf("@")),delete a[b]):this._labelFrames.push(c.start)}flax.copyProperties(this.define.sounds,this._frameSounds)}},addFrameSound:function(a,b){this._frameSounds[""+a]=b},removeFrameSound:function(a){delete this._frameSounds[""+a]},getLabels:function(a){return this.define.labels?this.define.labels[a]:null},hasLabel:function(a){return null!=this.getLabels(a)},getMainCollider:function(){return this.getCollider("main")||this._mainCollider},getPhysicsBody:function(){return this._physicsBody},
getCollider:function(a){var b=null;this._colliders&&(a=this._colliders[a],null!=a&&(b=a[this.currentFrame]));return b},createPhysics:function(a,b,c){null==a&&(a=Box2D.Dynamics.b2Body.b2_dynamicBody);this._physicsBodyParam={type:a,fixedRotation:b,bullet:c};if(!this.parent)return null;if(null==this._physicsBody){var d=new Box2D.Dynamics.b2BodyDef;d.type=a;d.fixedRotation=b;d.bullet=c;d.userData=this;a=flax.getPosition(this,!0);d.position.Set(a.x/PTM_RATIO,a.y/PTM_RATIO);this._physicsBody=flax.getPhysicsWorld().CreateBody(d);
this._physicsBody.__rotationOffset=this.rotation}return this._physicsBody},destroyPhysics:function(){this.removePhysicsShape()},addPhysicsShape:function(a,b,c,d,e,f,g){if(null==this._physicsBody)throw"Please createPhysics firstly!";var h=this.getCollider(a);if(null==h)return cc.log("There is no collider named: "+a),null;if(h.physicsFixture)return h.physicsFixture;var k={density:b,friction:c,restitution:d,isSensor:e,catBits:f,maskBits:g};if(this.parent)return a=h.createPhysics(b,c,d,e,f,g),-1==this._physicsColliders.indexOf(h)&&
this._physicsColliders.push(h),a;null==this._physicsToBeSet&&(this._physicsToBeSet={});null==this._physicsToBeSet[a]&&(this._physicsToBeSet[a]=k);return null},removePhysicsShape:function(a){for(var b=this._physicsColliders.length;b--;){var c=this._physicsColliders[b];if(null==a||c.name==a)c.destroyPhysics(),this._physicsColliders.splice(b,1)}0==this._physicsColliders.length&&(flax.removePhysicsBody(this._physicsBody),this._physicsBody=null)},_initColliders:function(){this._mainCollider=null;this._colliders=
{};var a=this.define.colliders;if(a){var b=null,c;for(c in a){this._colliders[c]=[];for(var d=a[c],e=-1;++e<d.length;)if(null==d[e])this._colliders[c][e]=null;else if(b=this._colliders[c][e]=new flax.Collider(d[e]),b.name=c,b.owner=this,"main"==c||"base"==c)this._mainCollider=b}}this._definedMainCollider=null!=this._mainCollider;this._definedMainCollider||(this._mainCollider=new flax.Collider("Rect,0,0,"+this.width+","+this.height+",0",!1),this._mainCollider.name="main",this._mainCollider.owner=this);
this._physicsColliders=[]},getRect:function(a){return this.getMainCollider().getRect(a)},getCenter:function(a){return this.getMainCollider().getCenter(a)},getAnchor:function(a){if(this.define.anchors){var b=this.define.anchors[a];if(null!=b)return b instanceof flax.Anchor||(b=new flax.Anchor(b[this.currentFrame]),this.define.anchors[a]=b),b}return null},bindAnchor:function(a,b,c){if(!this.define.anchors)return cc.log(this.assetID+": there is no any anchor!"),!1;if(null==this.define.anchors[a])return cc.log(this.assetID+
": there is no anchor named "+a),!1;if(null==b)throw"Node can't be null!";if(-1<this._anchorBindings.indexOf(b))return cc.log(this.assetID+": anchor has been bound, "+a),!1;!1!==c&&this._anchorBindings.push(b);b.__anchor__=a;this._updateAnchorNode(b,this.getAnchor(a));b.parent!=this&&(b.removeFromParent(!1),this.addChild(b));return!0},getCurrentLabel:function(){var a=this.define.labels;if(!a)return null;for(var b in a){var c=a[b];if(this.currentFrame>=c.start&&this.currentFrame<=c.end)return b}return null},
nextFrame:function(){this.gotoAndStop(Math.min(++this.currentFrame,this.totalFrames-1))},prevFrame:function(){this.gotoAndStop(Math.max(--this.currentFrame,0))},play:function(){this._isLanguageElement||this.__isButton||(this._loopStart=0,this._loopEnd=this.totalFrames-1,this.updatePlaying(!0),this.currentAnim=null)},playSequence:function(a){if(null==a)return!1;a instanceof Array||(a=Array.prototype.slice.call(arguments));if(0==a.length)return!1;this._loopSequence=!1;this._sequenceIndex=0;var b=this.gotoAndPlay(a[0]);
this._animSequence=a;return b},playSequenceLoop:function(a){a instanceof Array||(a=Array.prototype.slice.call(arguments));this.playSequence(a);this._loopSequence=!0},setSubAnim:function(a,b){if(!a||0==a.length)return!1;if(null==this._subAnims||-1==this._subAnims.indexOf(a))return this.__isButton||cc.log("There is no animation named: "+a),!1;this.setSource(this.assetsFile,this._baseAssetID+"$"+a);!1===b?this.gotoAndStop(0):this.gotoAndPlay(0);this.currentAnim=a;this._animTime=0;return!0},gotoAndPlay:function(a,
b){if(this._isLanguageElement||this.__isButton)return!1;if("string"===typeof a){if(this.playing&&this.currentAnim==a&&!0!==b)return!0;var c=this.getLabels(a);if(null==c)return c=this.setSubAnim(a,!0),c||(cc.log("There is no animation named: "+a),this.play()),c;this._loopStart=c.start;this._loopEnd=c.end;this.currentFrame=this._loopStart;this.currentAnim=a}else{if(!this.isValideFrame(a))return cc.log("The frame: "+a+" is out of range!"),!1;this._loopStart=0;this._loopEnd=this.totalFrames-1;this.currentFrame=
a;this.currentAnim=null}this.renderFrame(this.currentFrame);this.updatePlaying(!0);this._animTime=0;return!0},stop:function(){this.updatePlaying(!1);this.currentAnim=null},gotoAndStop:function(a){if(isNaN(a)){var b=this.getLabels(a);if(null==b)return(b=this.setSubAnim(a,!1))||this.__isButton||cc.log("There is no animation named: "+a),b;a=b.start}this.currentAnim=null;if(!this.isValideFrame(a))return cc.log("The frame: "+a+" is out of range!"),!1;this.updatePlaying(!1);this.currentFrame=a;this.renderFrame(a);
return!0},setFPS:function(a){this._fps!=a&&(this._fps=a,this.updateSchedule())},getFPS:function(){return this._fps},updatePlaying:function(a){this.playing!=a&&(this.playing=a,this.updateSchedule())},updateSchedule:function(){this.playing?1<this.totalFrames&&this.schedule(this.onFrame,1/this._fps):this.unschedule(this.onFrame)},_animTime:0,onFrame:function(a){if(this.visible){this.currentFrame++;this._animTime+=a;this.currentFrame>this._loopEnd&&(this.currentFrame=this._loopEnd,(this.autoDestroyWhenOver||
this.autoStopWhenOver||this.autoHideWhenOver)&&this.updatePlaying(!1),this.onAnimationOver.getNumListeners()&&this.onAnimationOver.dispatch(this),this.autoDestroyWhenOver?this.destroy():this.autoHideWhenOver?this.visible=!1:this._animSequence.length?this._playNext():this.autoStopWhenOver||(this.currentFrame=this._loopStart),this._animTime=0);if(this.currentFrame>this._loopEnd||this.currentFrame>this.totalFrames-1)this.currentFrame=this._loopStart;this.renderFrame(this.currentFrame)}},_playNext:function(){this._sequenceIndex++;
if(this._sequenceIndex>=this._animSequence.length){this.onSequenceOver.getNumListeners()&&this.onSequenceOver.dispatch(this);if(!this._loopSequence){this.autoStopWhenOver||this.gotoAndPlay(this._animSequence[this._sequenceIndex-1],!0);this._animSequence=[];return}this._sequenceIndex=0}var a=this._animSequence,b=a[this._sequenceIndex];if("number"===typeof b)if(this._loopSequence&&this._sequenceIndex==a.length-1?this._sequenceIndex=0:this._sequenceIndex++,a.length>this._sequenceIndex&&"string"===typeof a[this._sequenceIndex]){var c=
b,b=a[this._sequenceIndex];this.scheduleOnce(function(){this.gotoAndPlay(b)},c-this._animTime);this.updatePlaying(!1)}else this._animSequence=[],this.currentFrame=this._loopStart;else this.gotoAndPlay(b)},isValideFrame:function(a){return 0<=a&&a<this.totalFrames},renderFrame:function(a,b){if(this._prevFrame!=a||!0==b){this._prevFrame!=a&&(this._prevFrame=a);this._handleAnchorBindings();this._updateCollider();this.doRenderFrame(a);this.onFrameChanged.getNumListeners()&&this.onFrameChanged.dispatch(this.currentFrame);
-1<this._labelFrames.indexOf(a)&&this.onFrameLabel.dispatch(this.getCurrentLabel(a));var c=this._frameSounds[""+a];c&&flax.playSound(c)}},doRenderFrame:function(a){},_handleAnchorBindings:function(){for(var a=null,b=null,c=-1,d=this._anchorBindings.length;++c<d;)a=this._anchorBindings[c],a.visible&&(b=this.getAnchor(a.__anchor__),null!=b&&this._updateAnchorNode(a,b))},_updateAnchorNode:function(a,b){null!=b&&(a.x=b.x,a.y=b.y,a.zIndex=b.zIndex,a.rotation=b.rotation)},onEnter:function(){this._super();
this._destroyed=!1;this._updateCollider();this._physicsBodyParam&&this.createPhysics(this._physicsBodyParam.type,this._physicsBodyParam.fixedRotation,this._physicsBodyParam.bullet);if(this._physicsToBeSet)for(var a in this._physicsToBeSet){var b=this.getCollider(a),c=this._physicsToBeSet[a];b.createPhysics(c.density,c.friction,c.restitution,c.isSensor,c.catBits,c.maskBits);delete this._physicsToBeSet[a];-1==this._physicsColliders.indexOf(b)&&this._physicsColliders.push(b)}this._updateLaguage();flax.callModuleOnEnter(this);
this.__fromPool&&(this.__fromPool=!1,this.release())},onExit:function(){this._super();this.onAnimationOver.removeAll();this.onSequenceOver.removeAll();this.onFrameChanged.removeAll();this.onFrameLabel.removeAll();flax.inputManager.removeListener(this);this.__isInputMask&&flax.inputManager.removeMask(this);for(var a=null,b=-1,c=this._anchorBindings.length;++b<c;)a=this._anchorBindings[b],a.destroy?a.destroy():a.removeFromParent(!0),delete a.__anchor__;for(b=this._anchorBindings.length=0;b<this._physicsColliders.length;b++)this._physicsColliders[b].destroyPhysics();
this._physicsColliders=[];this._physicsBody&&(flax.removePhysicsBody(this._physicsBody),this._physicsBody=null);this._physicsBodyParam=null;flax.callModuleOnExit(this)},_updateLaguage:function(){(this._isLanguageElement=-1<flax.languageIndex&&this.name&&0==this.name.indexOf("label__"))&&(this.gotoAndStop(flax.languageIndex)||this.gotoAndStop(0))},_updateCollider:function(){},setPosition:function(a,b){var c=!1;void 0===b?(c=a.x!=this.x||a.y!=this.y)&&this._super(a):(c=a!=this.x||b!=this.y)&&this._super(a,
b);c&&this.parent&&(flax.callModuleFuction(this,"onPosition"),this._updateCollider())},setPositionX:function(a){this.setPosition(a,this.y)},setPositionY:function(a){this.setPosition(this.x,a)},_moveSpeed:null,_moveSpeedLen:0,_targetPos:null,_inMoving:!1,moveTo:function(a,b){var c=cc.pSub(a,this.getPosition());1>cc.pLength(c)||!b||0>=b?this.setPosition(a):(this._moveSpeed=cc.pMult(c,1/b),this._moveSpeedLen=cc.pLength(this._moveSpeed),this._targetPos=a,this._inMoving||this.schedule(this._doMove,flax.frameInterval,
cc.REPEAT_FOREVER))},moveToBySpeed:function(a,b){var c=cc.pSub(a,this.getPosition()),d=cc.pLength(c);1>d?this.setPosition(a):(this._moveSpeed=cc.pMult(c,b/d),this._moveSpeedLen=cc.pLength(this._moveSpeed),this._targetPos=a,this._inMoving||this.schedule(this._doMove,flax.frameInterval,cc.REPEAT_FOREVER))},_doMove:function(a){var b=this.getPosition();cc.pDistance(b,this._targetPos)<this._moveSpeedLen*a?(this.setPosition(this._targetPos),this._targetPos=this._moveSpeed=null,this._inMoving=!1,this.unschedule(this._doMove)):
this.setPosition(cc.pAdd(b,cc.pMult(this._moveSpeed,a)))},_destroyed:!1,destroy:function(){this._destroyed||(this._destroyed=!0,this.autoRecycle&&flax.ObjectPool.get(this.assetsFile,this.clsName,this.__pool__id__||"").recycle(this),this.removeFromParent())},onRecycle:function(){this.autoRecycle=!1;this.setScale(1);this.opacity=255;this.rotation=0;this.ignoreBodyRotation=this.autoHideWhenOver=this.autoStopWhenOver=this.autoDestroyWhenOver=!1;this.gotoAndStop(0);this.setPosition(0,0);this._animSequence.length=
0;this._loopSequence=!1;this._sequenceIndex=0;this.currentAnim=null;this.__isInputMask=!1},isMouseEnabled:function(){return this._mouseEnabled},setMouseEnabled:function(a){this._mouseEnabled=a},getDefine:function(){return null},onNewSource:function(){}};flax.FlaxSprite=cc.Sprite.extend(flax._sprite);flax.FlaxSprite.create=function(a,b){var c=new flax.FlaxSprite(a,b);c.clsName="flax.FlaxSprite";return c};flax.addModule(flax.FlaxSprite,flax.TileMapModule);window.flax.FlaxSprite=flax.FlaxSprite;
flax.FlaxSpriteBatch=cc.SpriteBatchNode.extend(flax._sprite);flax.FlaxSpriteBatch.create=function(a,b){var c=new flax.FlaxSpriteBatch(a,b);c.clsName="flax.FlaxSpriteBatch";return c};flax.addModule(flax.FlaxSpriteBatch,flax.TileMapModule);window.flax.FlaxSpriteBatch=flax.FlaxSpriteBatch;var _p=flax.FlaxSprite.prototype;cc.defineGetterSetter(_p,"mainCollider",_p.getMainCollider);cc.defineGetterSetter(_p,"physicsBody",_p.getPhysicsBody);cc.defineGetterSetter(_p,"center",_p.getCenter);
cc.defineGetterSetter(_p,"fps",_p.getFPS,_p.setFPS);cc.defineGetterSetter(_p,"tileMap",_p.getTileMap,_p.setTileMap);cc.defineGetterSetter(_p,"currentLabel",_p.getCurrentLabel);cc.defineGetterSetter(_p,"x",_p.getPositionX,_p.setPositionX);cc.defineGetterSetter(_p,"y",_p.getPositionY,_p.setPositionY);_p=flax.FlaxSpriteBatch.prototype;cc.defineGetterSetter(_p,"mainCollider",_p.getMainCollider);cc.defineGetterSetter(_p,"physicsBody",_p.getPhysicsBody);cc.defineGetterSetter(_p,"center",_p.getCenter);
cc.defineGetterSetter(_p,"fps",_p.getFPS,_p.setFPS);cc.defineGetterSetter(_p,"tileMap",_p.getTileMap,_p.setTileMap);cc.defineGetterSetter(_p,"currentLabel",_p.getCurrentLabel);cc.defineGetterSetter(_p,"x",_p.getPositionX,_p.setPositionX);cc.defineGetterSetter(_p,"y",_p.getPositionY,_p.setPositionY);flax.Animator=flax.FlaxSprite.extend({frameNames:null,clsName:"flax.Animator",onNewSource:function(){this.frameNames=flax.assetsManager.getFrameNames(this.assetsFile,this.define.start,this.define.end);this.totalFrames=this.frameNames.length;0==this.totalFrames&&cc.log("There is no frame for display: "+this.assetID)},doRenderFrame:function(a){this.setSpriteFrame(this.frameNames[a])},getDefine:function(){var a=flax.assetsManager.getDisplayDefine(this.assetsFile,this.assetID);if(null==a)throw"There is no Animator named: "+
this.assetID+" in assets: "+this.assetsFile+", or make sure this class extends from the proper class!";return a}});flax.Animator.create=function(a,b){var c=new flax.Animator(a,b);c.clsName="flax.Animator";return c};window.flax.Animator=flax.Animator;flax.Image=cc.Sprite.extend({define:null,name:null,assetsFile:null,assetID:null,clsName:"flax.Image",autoRecycle:!1,_anchorBindings:null,__instanceId:null,ctor:function(a,b){cc.Sprite.prototype.ctor.call(this);if(!a||!b)throw"Please set assetsFile and assetID to me!";this.__instanceId=ClassManager.getNewInstanceId();this._anchorBindings=[];this.setSource(a,b)},setSource:function(a,b){if(null==a||null==b)throw"assetsFile and assetID can not be null!";if(this.assetsFile!=a||this.assetID!=b){this.assetsFile=
a;this.assetID=b;this.define=flax.assetsManager.getDisplayDefine(this.assetsFile,this.assetID);var c=this.assetsFile.slice(0,this.assetsFile.lastIndexOf("/"));this.initWithFile(c+"/"+this.define.url);var c=this.define.anchorX,d=this.define.anchorY;isNaN(c)||isNaN(d)||this.setAnchorPoint(c,d);this.onNewSource();null==this.__pool__id__&&(this.__pool__id__=this.assetID)}},_destroyed:!1,destroy:function(){this._destroyed||(this._destroyed=!0,this.autoRecycle&&flax.ObjectPool.get(this.assetsFile,this.clsName,
this.__pool__id__||"").recycle(this),this.removeFromParent())},onEnter:function(){this._super();this._destroyed=!1},onExit:function(){this._super();flax.inputManager.removeListener(this);for(var a=null,b=-1,c=this._anchorBindings.length;++b<c;)a=this._anchorBindings[b],a.destroy?a.destroy():a.removeFromParent(!0),delete a.__anchor__;this._anchorBindings.length=0},onRecycle:function(){this.autoRecycle=!1;this.setScale(1);this.opacity=255;this.rotation=0;this.setPosition(0,0)},getAnchor:function(a){return this.define.anchors&&
(a=this.define.anchors[a],null!=a)?new flax.Anchor(a[0]):null},bindAnchor:function(a,b,c){if(!this.define.anchors)return cc.log(this.assetID+": there is no any anchor!"),!1;if(null==this.define.anchors[a])return cc.log(this.assetID+": there is no anchor named "+a),!1;if(null==b)throw"Node can't be null!";if(-1<this._anchorBindings.indexOf(b))return cc.log(this.assetID+": anchor has been bound, "+a),!1;!1!==c&&this._anchorBindings.push(b);b.__anchor__=a;this._updateAnchorNode(b,this.getAnchor(a));
b.parent!=this&&(b.removeFromParent(!1),this.addChild(b));return!0},_updateAnchorNode:function(a,b){null!=b&&(a.x=b.x,a.y=b.y,a.zIndex=b.zIndex,a.rotation=b.rotation)},onNewSource:function(){}});window.flax.Image=flax.Image;flax.FrameData=cc.Class.extend({x:0,y:0,rotation:0,scaleX:1,scaleY:1,opacity:255,zIndex:-1,skewX:0,skewY:0,font:null,fontSize:12,fontColor:"",textAlign:"",textWidth:40,textHeight:20,_isText:!1,_data:null,_hasSkew:!1,ctor:function(a){this._data=a;this.x=parseFloat(a[0]);this.y=parseFloat(a[1]);this.rotation=parseFloat(a[2]);this.scaleX=parseFloat(a[3]);this.scaleY=parseFloat(a[4]);this.opacity=Math.round(255*parseFloat(a[5]));6<a.length&&(this.zIndex=parseInt(a[6]));7<a.length&&(this.skewX=parseFloat(a[7]));
8<a.length&&(this.skewY=parseFloat(a[8]));this._hasSkew=7<a.length;9<a.length&&(this._isText=!0,this.font=a[9],this.fontSize=parseInt(a[10]),this.fontColor=cc.hexToColor(a[11]),this.textAlign=H_ALIGHS.indexOf(a[12]),this.textWidth=parseFloat(a[13]),this.textHeight=parseFloat(a[14]))},setForChild:function(a){this._hasSkew||this.rotation==a.rotation||(a.rotation=this.rotation);this.scaleX!=a.scaleX&&(a.scaleX=this.scaleX);this.scaleY!=a.scaleY&&(a.scaleY=this.scaleY);this._hasSkew&&(a.rotationX=this.skewX,
a.rotationY=this.skewY);a.setOpacity&&this.opacity!=a.opacity&&(a.opacity=this.opacity);var b=this.x,c=this.y;this.font&&a instanceof cc.LabelTTF&&(a.setFontName(this.font),a.setFontFillColor(this.fontColor),a.setHorizontalAlignment(this.textAlign),a.setDimensions({width:this.textWidth,height:this.textHeight}),a.setFontSize(this.fontSize-1),a.setFontSize(this.fontSize),b+=this.textWidth/2,c-=this.textHeight/2);b!=a.x&&(a.x=b);c!=a.y&&(a.y=c)},clone:function(){return new flax.FrameData(this._data)}});
flax._movieClip={clsName:"flax.MovieClip",autoPlayChildren:!1,sameFpsForChildren:!0,_namedChildren:null,_theRect:null,_frameDatas:null,__isMovieClip:!0,replaceChild:function(a,b,c){var d=this.define.children[a];if(null==d)cc.log("There is no child with named: "+a+"  in MovieClip: "+this.assetID);else{var e=this._namedChildren[a];if(e){c||(c=this.assetsFile);d=flax.assetsManager.getAssetType(c,b);if(!d)throw"There is no display with assetID: "+b+" in assets: "+c;flax.assetsManager.getAssetType(e.assetsFile,
e.assetID)==d?e.setSource(c,b):(e.destroy(),e=flax.assetsManager.createDisplay(c,b,null,!0),e.name=a,this._namedChildren[a]=e,this.autoPlayChildren&&flax.isFlaxSprite(e)&&(this.playing?e.gotoAndPlay(0):e.gotoAndStop(0)),this[a]=e,this.addChild(e))}else d["class"]=b,d.assetsFile=c}},onNewSource:function(){for(var a in this._namedChildren)this._namedChildren[a].destroy(),delete this._namedChildren[a],delete this[a];this._namedChildren={};this.totalFrames=this.define.totalFrames;this._theRect=this._strToRect(this.define.rect);
this.setContentSize(this._theRect.width,this._theRect.height);this._initFrameDatas()},_initFrameDatas:function(){this._frameDatas={};for(var a in this.define.children){for(var b=[],c=this.define.children[a].frames,d=-1;++d<c.length;){var e=c[d];e&&(e=e.split(","),b[d]=new flax.FrameData(e))}this._frameDatas[a]=b}},onEnter:function(){this._super();this.setContentSize(this._theRect.width,this._theRect.height)},doRenderFrame:function(a){var b,c,d,e;for(e in this.define.children)c=this.define.children[e],
d=this._frameDatas[e][a],b=this._namedChildren[e],d?(null==b&&(b=null!=c.text?flax.Label.create(this.assetsFile,d,c):flax.assetsManager.createDisplay(c.assetsFile||this.assetsFile,c["class"],null,!0),b.name=e,this._namedChildren[e]=b,this.autoPlayChildren&&flax.isFlaxSprite(b)&&(this.playing?b.gotoAndPlay(0):b.gotoAndStop(0)),this[e]=b,this.onNewChild(b)),d.setForChild(b),this.sameFpsForChildren&&(b.fps=this.fps),b.visible=!0,(b.autoPlayChildren=this.autoPlayChildren)&&flax.isFlaxSprite(b)&&(this.playing?
b.play():b.stop()),c=-1==d.zIndex?c.zIndex:d.zIndex,b.parent!=this?(b.removeFromParent(!1),this.addChild(b,c)):b.zIndex!=c&&(b.zIndex=c)):b&&(b.destroy?b.destroy():b.removeFromParent(!0),delete this._namedChildren[e],delete this[e])},stop:function(){this._super();if(this.autoPlayChildren)for(var a in this._namedChildren){var b=this._namedChildren[a];flax.isFlaxSprite(b)&&b.stop()}},play:function(){this._super();if(this.autoPlayChildren)for(var a in this._namedChildren){var b=this._namedChildren[a];
flax.isFlaxSprite(b)&&b.play()}},onNewChild:function(a){},getDefine:function(){var a=flax.assetsManager.getMc(this.assetsFile,this.assetID);if(null==a)throw"There is no MovieClip named: "+this.assetID+" in assets: "+this.assetsFile+", or make sure this class extends from the proper class!";return a},getChild:function(a,b){void 0===b&&(b=!0);var c=this._namedChildren[a];if(c)return c;if(!b)return null;for(var d in this._namedChildren)if(c=this._namedChildren[d],c.getChild&&(c=c.getChild(a,b)))return c;
return null},getChildByAssetID:function(a){var b=null,c;for(c in this._namedChildren)if(b=this._namedChildren[c],b.assetID==a)return b;return null},getLabelText:function(a,b){var c=this.getChild(a,void 0===b?!0:b);return c&&c instanceof flax.Label?c.getString():null},setLabelText:function(a,b,c){return(a=this.getChild(a,void 0===c?!0:c))&&a instanceof flax.Label?(a.setString(b),a):null},setFPS:function(a){if(this._fps!=a&&(this._fps=a,this.updateSchedule(),this.sameFpsForChildren)){a=null;for(var b in this._namedChildren)a=
this._namedChildren[b],a.fps=this._fps}},onRecycle:function(){this._super();this.autoPlayChildren=!1;for(var a in this._namedChildren){var b=this._namedChildren[a];flax.isFlaxSprite(b)&&b.gotoAndStop(0)}},_strToRect:function(a){a=a.split(",");return cc.rect(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]))}};flax.MovieClip=flax.FlaxSprite.extend(flax._movieClip);flax.MovieClip.create=function(a,b){var c=new flax.MovieClip(a,b);c.clsName="flax.MovieClip";return c};
window.flax.MovieClip=flax.MovieClip;flax.MovieClipBatch=flax.FlaxSpriteBatch.extend(flax._movieClip);flax.MovieClipBatch.create=function(a,b){var c=new flax.MovieClipBatch(a,b);c.clsName="flax.MovieClipBatch";return c};window.flax.MovieClipBatch=flax.MovieClipBatch;flax.ProgressBarType={HORIZONTAL:"horizontal",VERTICAL:"vertical",RADIAL:"radial"};
flax.ProgressBar=flax.Animator.extend({pBar:null,_type:flax.ProgressBarType.HORIZONTAL,_reversed:!1,_tween:null,onEnter:function(){this._super()},getPercentage:function(){return this.pBar?this.pBar.percentage:0},setPercentage:function(a){this.pBar&&(this.pBar.percentage=a)},getType:function(){return this._type},setType:function(a){this._type!=a&&(this._type=a,this._updatePBar())},getReversed:function(){return this._reversed},setReversed:function(a){this._reversed!=a&&(this._reversed=a,this._updatePBar(),
this.percentage+=0.1,this.percentage-=0.1)},tween:function(a,b,c){null!=this.pBar&&(this._tween&&(this.pBar.stopAction(this._tween),this._tween.release()),this._tween=cc.progressFromTo(c,a,b),this._tween.retain(),this.pBar.runAction(this._tween))},stopTween:function(){this._tween&&this.pBar&&(this.pBar.stopAction(this._tween),this._tween.release(),this._tween=null)},doRenderFrame:function(a){if(a=cc.spriteFrameCache.getSpriteFrame(this.frameNames[a]))a=cc.Sprite.create(a),null==this.pBar?(this.width=
a.width,this.height=a.height,this.pBar=cc.ProgressTimer.create(a),this._updatePBar(),this.pBar.setAnchorPoint(this.getAnchorPoint()),this.pBar.setPosition(this.getAnchorPointInPoints()),this.addChild(this.pBar)):this.pBar.setSprite(a)},_updatePBar:function(){if(null!=this.pBar)if(this._type==flax.ProgressBarType.RADIAL)this.pBar.type=0,this.pBar.setReverseDirection(this._reversed),this.pBar.midPoint=cc.p(0.5,0.5);else{this.pBar.type=1;var a=this._type==flax.ProgressBarType.HORIZONTAL,b=cc.p(0,0),
c=cc.p(a?1:0,a?0:1);this._reversed&&(a?b.x=1:b.y=1);this.pBar.midPoint=b;this.pBar.barChangeRate=c}}});flax.ProgressBar.create=function(a,b){var c=new flax.ProgressBar(a,b);c.clsName="flax.ProgressBar";return c};window.flax.ProgressBar=flax.ProgressBar;_p=flax.ProgressBar.prototype;cc.defineGetterSetter(_p,"percentage",_p.getPercentage,_p.setPercentage);cc.defineGetterSetter(_p,"type",_p.getType,_p.setType);cc.defineGetterSetter(_p,"reversed",_p.getReversed,_p.setReversed);flax.Label=cc.Sprite.extend({mlWidth:0,mlHeight:0,fontName:null,fontSize:20,frames:[],chars:[],assetsFile:null,name:null,params:null,_str:null,_gap:0,_spaceGap:10,_charCanvas:null,_fontDefine:null,getString:function(){return this._str},setString:function(a){a!==this._str&&(this._str=""+a,this._updateStr())},getSpaceGap:function(){return this._spaceGap},setSpaceGap:function(a){this._spaceGap!=a&&(this._spaceGap=a,this._str&&-1<this._str.indexOf(" ")&&this._updateStr())},getGap:function(){return this._gap},
setGap:function(a){a!=this._gap&&(this._gap=a,this._str&&this._updateStr())},setFontName:function(a){if(null!=a&&(null==this.fontName||this.fontName!=a)){this.fontName=a;this._fontDefine=flax.assetsManager.getFont(this.assetsFile,this.fontName);if(null==this._fontDefine)throw"Can't find the font named: "+this.fontName;this.frames=flax.assetsManager.getFrameNames(this.assetsFile,parseInt(this._fontDefine.start),parseInt(this._fontDefine.end));this.chars=this._fontDefine.chars;this.fontSize=parseInt(this._fontDefine.size)}},
tweenInt:function(a,b,c){this.setString(a);var d=flax.numberSign(b-a);if(0!=d){var e=Math.abs(b-a),f=Math.max(c/e,flax.frameInterval),e=Math.round(c/f),d=d*Math.round(Math.abs(b-a)/e);this.schedule(function(a){a=parseInt(this._str);var c=a+d;0<d&&c>b?c=b:0>d&&c<b&&(c=b);c!=a&&this.setString(c)},f,e+10)}},_updateStr:function(){if(null==this._charCanvas){var a=cc.path.changeBasename(this.assetsFile,".png");this._charCanvas=new cc.SpriteBatchNode(a,this._str.length);this.addChild(this._charCanvas)}this._charCanvas.removeAllChildren();
for(i=this.mlHeight=this.mlWidth=0;i<this._str.length;i++)if(a=this._str[i],"\n"!=a)if(" "==a)this.mlWidth+=this._spaceGap;else{for(var b=-1,c=0;c<this.chars.length;c++)if(this.chars[c]==a){b=c;break}-1==b?cc.log("Not found the char: "+a+" in the fonts: "+this.fontName):(sprite=cc.Sprite.create(cc.spriteFrameCache.getSpriteFrame(this.frames[b])),sprite.anchorX=this._fontDefine.anchorX,sprite.anchorY=this._fontDefine.anchorY,a=sprite.getContentSize(),sprite.x=this.mlWidth,sprite.y=0,this.mlWidth+=
a.width,i!=this._str.length-1&&(this.mlWidth+=this._gap),this.mlHeight=a.height>this.mlHeight?a.height:this.mlHeight,this._charCanvas.addChild(sprite))}if(this.params)for(b=Math.max(this.mlWidth/this.params.textWidth,this.mlHeight/this.params.textHeight),a=0,1<b&&(c=1/b,this._charCanvas.scale=c,a=this.mlHeight*(1-1/b)*b,this.mlWidth*=c,this.mlHeight*=c),b=(this.params.textWidth-this.mlWidth)/2,i=this._charCanvas.childrenCount;i--;)charChild=this._charCanvas.children[i],"center"==H_ALIGHS[this.params.textAlign]?
charChild.x+=b:"right"==H_ALIGHS[this.params.textAlign]&&(charChild.x+=2*b),charChild.y-=a;this._charCanvas.setContentSize(this.mlWidth,this.mlHeight);this.setContentSize(this.mlWidth,this.mlHeight)},getRect:function(a){a=!1!==a;var b=cc.rect(0.5*this.width/this._str.length,-this.params.textHeight,this.width,this.height+2);b.y+=(this.params.textHeight-this.height)/2-1;if(!a)return b;a=b.width;var c=b.height,b=cc.p(b.x,b.y),b=this.convertToWorldSpace(b);return cc.rect(b.x,b.y,a,c)},destroy:function(){this.removeFromParent()}});
_p=flax.Label.prototype;cc.defineGetterSetter(_p,"gap",_p.getGap,_p.setGap);cc.defineGetterSetter(_p,"spaceGap",_p.getSpaceGap,_p.setSpaceGap);cc.defineGetterSetter(_p,"text",_p.getString,_p.setString);_p=cc.LabelTTF.prototype;cc.defineGetterSetter(_p,"text",_p.getString,_p.setString);
flax.Label.create=function(a,b,c){if(!1===b._isText)throw"The assetsFile: "+a+" was exported with old version of Flax tool, re-export it to fix the Text issue!";cc.sys.isNative||(c.text=c.text.split("\\").join(""));var d=null,e=c["class"],d=flax.assetsManager.getFont(a,e);if(!0==c.input){if(null==cc.EditBox)throw"If you want to use input text, please add module of 'editbox' into project.json!";d=flax.assetsManager.getFrameNamesOfDisplay(a,e);d=new cc.EditBox(cc.size(b.textWidth,b.textHeight),new cc.Scale9Sprite(d[0]),
d[1]?new cc.Scale9Sprite(d[1]):null,d[2]?new cc.Scale9Sprite(d[2]):null);d.setFontColor(b.fontColor);d.setFontName(b.font);d.setFontSize(b.fontSize);d.setPlaceHolder(c.text);d.setPlaceholderFontName(b.font);d.setPlaceholderFontSize(b.fontSize);b=flax.assetsManager.getDisplayDefine(a,e);d.setAnchorPoint(b.anchorX,b.anchorY)}else b.font&&null==d?(a=new cc.FontDefinition,a.fontName=b.font,a.fontSize=b.fontSize,a.textAlign=b.textAlign,a.verticalAlign=cc.VERTICAL_TEXT_ALIGNMENT_CENTER,a.fillStyle=b.fontColor,
a.fontDimensions=!0,a.boundingWidth=b.textWidth,a.boundingHeight=b.textHeight,d="null"==e?new cc.LabelTTF(c.text,a):new cc.LabelTTF(flax.getLanguageStr(e)||c.text,a)):(d=new flax.Label,flax.assetsManager.addAssets(a),d.assetsFile=a,d.params=b,d.setFontName(e),d.setAnchorPoint(0,0),d.setString(c.text));return d};flax._fontResources=null;flax.registerFont=function(a,b){a&&b&&("string"==typeof b&&(b=[b]),null==flax._fontResources&&(flax._fontResources={}),flax._fontResources[a]=b)};var ButtonState={UP:"up",OVER:"over",DOWN:"down",SELECTED:"selected",SELECTED_OVER:"selected_over",SELECTED_DOWN:"selected_down",DISABLED:"disabled"};MOUSE_DOWN_SCALE=0.95;
flax._buttonDefine={clickSound:null,group:null,_playChildrenOnState:!1,_state:null,_initScale:null,__isButton:!0,onEnter:function(){this._super();this._initScale={x:this.scaleX,y:this.scaleY};flax.inputManager.addListener(this,this._onPress,InputType.press);flax.inputManager.addListener(this,this._onClick,InputType.click);flax.inputManager.addListener(this,this._onMove,InputType.move)},onExit:function(){this.group&&(this.group.removeButton(this),this.group=null);this._super()},onRecycle:function(){this._super();
this._playChildrenOnState=!1;this._state=null},setState:function(a){if(this._state!=a){var b=this.isSelected();this._state=a;this.gotoAndStop(this._state)||(a=this.isSelected()?ButtonState.SELECTED:ButtonState.UP,this.gotoAndStop(a)||(1==this.totalFrames&&this._initScale&&(-1<this._state.indexOf("down")?(this.scaleX=this._initScale.x*MOUSE_DOWN_SCALE,this.scaleY=this._initScale.y*MOUSE_DOWN_SCALE):(this.scaleX=this._initScale.x,this.scaleY=this._initScale.y)),this.gotoAndStop(0)));this._playOrPauseChildren();
this.isSelected()&&!b&&this.group&&this.group.updateButtons(this)}},getState:function(){return this._state},isSelected:function(){return this._state&&0==this._state.indexOf("selected")},setSelected:function(a){this.isSelected()!=a&&this.isSelectable()&&this.isMouseEnabled()&&this.setState(a?ButtonState.SELECTED:ButtonState.UP)},isSelectable:function(){return this.hasLabel(ButtonState.SELECTED)},setMouseEnabled:function(a){if(this.isMouseEnabled()==a)return!1;this.setState(a?ButtonState.UP:ButtonState.DISABLED);
return!0},isMouseEnabled:function(){return this._state!=ButtonState.DISABLED},setPlayChildrenOnState:function(a){this._playChildrenOnState!=a&&(this._playChildrenOnState=a,this._playOrPauseChildren())},getPlayChildrenOnState:function(){return this._playChildrenOnState},_onPress:function(a,b){var c=this.clickSound||flax.buttonSound;c&&flax.playSound(c);this._toSetState(ButtonState.DOWN)},_onClick:function(a,b){this.isSelectable()?!this.isSelected()||this.group?this.setState(ButtonState.SELECTED):this.setState(ButtonState.UP):
this.setState(ButtonState.UP)},_onMove:function(a,b){flax.ifTouched(this,a.getLocation())?this._toSetState(ButtonState.DOWN):this._toSetState(ButtonState.UP)},_toSetState:function(a){this.isSelectable()&&this.isSelected()&&(a=a==ButtonState.UP?ButtonState.SELECTED:"selected_"+a);this.setState(a)},_playOrPauseChildren:function(){for(var a=this.childrenCount;a--;){var b=this.children[a];flax.isFlaxSprite(b)&&(this._playChildrenOnState?(b.autoPlayChildren=!0,b.play()):(b.autoPlayChildren=!1,b.stop()))}}};
flax.SimpleButton=flax.Animator.extend(flax._buttonDefine);flax.SimpleButton.create=function(a,b){var c=new flax.SimpleButton(a,b);c.clsName="flax.SimpleButton";c.setState(ButtonState.UP);return c};window.flax.SimpleButton=flax.SimpleButton;_p=flax.SimpleButton.prototype;cc.defineGetterSetter(_p,"state",_p.getState,_p.setState);cc.defineGetterSetter(_p,"playChildrenOnState",_p.getPlayChildrenOnState,_p.setPlayChildrenOnState);cc.defineGetterSetter(_p,"selected",_p.isSelected,_p.setSelected);
flax.Button=flax.MovieClip.extend(flax._buttonDefine);flax.Button.create=function(a,b){var c=new flax.Button(a,b);c.clsName="flax.Button";c.setState(ButtonState.UP);return c};window.flax.Button=flax.Button;_p=flax.Button.prototype;cc.defineGetterSetter(_p,"state",_p.getState,_p.setState);cc.defineGetterSetter(_p,"playChildrenOnState",_p.getPlayChildrenOnState,_p.setPlayChildrenOnState);cc.defineGetterSetter(_p,"selected",_p.isSelected,_p.setSelected);
flax.ButtonGroup=cc.Class.extend({buttons:null,selectedButton:null,onSelected:null,ctor:function(a){this.buttons=[];this.onSelected=new signals.Signal},addButton:function(a){a instanceof Array||(a=Array.prototype.slice.call(arguments));for(var b=0;b<a.length;b++){var c=a[b];!flax.isButton(c)||-1<this.buttons.indexOf(c)||(this.buttons.push(c),c.group=this)}},removeButton:function(a){var b=this.buttons.indexOf(a);-1<b&&(this.buttons.splice(b,1),a.group=null,this.selectedButton==a&&(this.selectedButton=
this.buttons[0])&&this.selectedButton.setState(ButtonState.SELECTED));0==this.buttons.length&&(this.onSelected.removeAll(),this.onSelected=null)},updateButtons:function(a){for(var b=0;b<this.buttons.length;b++){var c=this.buttons[b];c!=a&&c.setState(ButtonState.UP)}this.selectedButton=a;this.onSelected.dispatch(a)}});flax.Preloader=cc.Scene.extend({_interval:null,_length:0,_count:0,_label:null,_className:"flax.Preloader",_logo:null,_inited:!1,init:function(){if(!this._inited){this._inited=!0;var a=this,b=cc.director.getWinSize(),c=cc.p(b.width/2,b.height/2),d=cc.game.config.loading;d&&flax.isImageFile(d)?cc.loader.load(d,function(){a._logo=cc.Sprite.create(d);a._logo.setPosition(c);a.addChild(a._logo,10);cc.sys.isNative||a.createLabel(cc.pSub(c,cc.p(0,a._logo.height/2+10)));a.logoClick()}):a.createLabel(c);return!0}},
createLabel:function(a){var b=this._label=cc.LabelTTF.create("Loading...","Arial",16);b.enableStroke(cc.color(51,51,51),2);b.setColor(cc.color(255,255,255));b.setPosition(a);this.addChild(b,10)},logoClick:function(){var a=this._logo,b=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!1,onTouchBegan:function(b,d){cc.rectContainsPoint(flax.getRect(a,!0),b.getLocation())&&flax.goHomeUrl()}});cc.eventManager.addListener(b,this._logo)},onEnter:function(){cc.Node.prototype.onEnter.call(this);
this.schedule(this._startLoading,0.3)},onExit:function(){cc.Node.prototype.onExit.call(this);this._label&&this._label.setString("Loaded")},initWithResources:function(a,b){this.init();"string"==typeof a&&(a=[a]);this.resources=a||[];this.cb=b},_startLoading:function(){var a=this;a.unschedule(a._startLoading);cc.loader.load(a.resources,function(b,c,d){null!=a._label&&(Math.min(d/c*100|0,100),a._label.setString("Loading: "+(d+1)+"/"+c))},function(){a.cb&&a.cb()})}});window.flax.Preloader=flax.Preloader;ALL_DIRECTONS="UP DOWN LEFT RIGHT LEFT_UP RIGHT_UP RIGHT_DOWN LEFT_DOWN".split(" ");ALL_DIRECTONS0="UP DOWN LEFT RIGHT LEFT_UP LEFT_DOWN".split(" ");ALL_DIRECTONS1="UP DOWN LEFT RIGHT RIGHT_UP RIGHT_DOWN".split(" ");EIGHT_DIRECTIONS_VALUE={UP:[0,1],DOWN:[0,-1],LEFT:[-1,0],RIGHT:[1,0],LEFT_UP:[-1,1],RIGHT_UP:[1,1],RIGHT_DOWN:[1,-1],LEFT_DOWN:[-1,-1]};MAX_IN_TILE=10;
flax.TileMap=cc.Class.extend({id:"default",offsetX:0,offsetY:0,isHexagon:!1,autoLayout:!1,_tileWidth:0,_tileHeight:0,_mapWidth:0,_mapHeight:0,_objectsMap:null,_objectsArr:null,_inUpdate:!1,ctor:function(a){a&&(this.id=a)},update:function(a){for(a=this._objectsArr?this._objectsArr.length:0;a--;){var b=this._objectsArr[a];b.autoUpdateTileWhenMove&&b.updateTile()}},setTileSize:function(a,b){if(this._tileWidth!=a||this._tileHeight!=b)this._tileWidth=a,this._tileHeight=b},getTileSize:function(){return{width:this._tileWidth,
height:this._tileHeight}},setMapSizePixel:function(a,b){null==a&&(a=cc.visibleRect.width);null==b&&(b=cc.visibleRect.height);return this.setMapSize(Math.ceil(a/this._tileWidth),Math.ceil(b/this._tileHeight))},getMapSizePixel:function(){var a=cc.size(this._tileWidth*this._mapWidth,this._tileHeight*this._mapHeight);this.isHexagon&&(a.width+=0.5*this._tileWidth);return a},setMapSize:function(a,b){var c=[[],[]];if(this._mapWidth==a&&this._mapHeight==b)return c;null==this._objectsArr&&(this._objectsArr=
[]);null==this._objectsMap&&(this._objectsMap=[]);for(var d=this._mapWidth,e=this._mapHeight,f=-1,g=-1,h=Math.max(a,d),k=Math.max(b,e);++f<h;){null==this._objectsMap[f]&&(this._objectsMap[f]=[]);for(g=-1;++g<k;)f>=a||g>=b?(c[0]=c[0].concat(this._objectsMap[f][g]),this.removeObjects(f,g),delete this._objectsMap[f][g]):f<d&&g<e||(this._objectsMap[f][g]=[],c[1].push([f,g]));0==this._objectsMap[f].length&&delete this._objectsMap[f]}this._mapWidth=a;this._mapHeight=b;return c},getMapSize:function(){return{width:this._mapWidth,
height:this._mapHeight}},showDebugGrid:function(){if(null!=flax.currentScene){flax.tileMapCanvas?flax.tileMapCanvas.clear():(flax.tileMapCanvas=cc.DrawNode.create(),flax.currentScene.addChild(flax.tileMapCanvas,1E5));flax.tileMapCanvas.setPosition(this.offsetX,this.offsetY);for(var a=0;a<=this._mapWidth;a++)flax.tileMapCanvas.drawSegment(cc.p(a*this._tileWidth,0),cc.p(a*this._tileWidth,this._tileHeight*this._mapHeight),1,cc.color(255,0,0,255));for(a=0;a<=this._mapHeight;a++)flax.tileMapCanvas.drawSegment(cc.p(0,
a*this._tileHeight),cc.p(this._tileWidth*this._mapWidth,a*this._tileHeight),1,cc.color(255,0,0,255))}},showDebugTile:function(a,b,c){a=this.getTiledPosition(a,b);null==c&&(c=cc.color(0,255,0,128));flax.drawRect(cc.rect(a.x-this._tileWidth/2,a.y-this._tileHeight/2,this._tileWidth,this._tileHeight),1,c,c)},clear:function(a){if(0!=this._objectsArr.length){void 0===a&&(a=!0);for(var b,c=0;c<this._mapWidth;c++)for(var d=0;d<this._mapHeight;d++){if(a){b=this._objectsMap[c][d];for(var e in b){var f=b[e];
f instanceof cc.Node&&f.destroy()}}this._objectsMap[c][d]=[]}this._objectsArr.length=0}},getTileIndex:function(a){var b=Math.floor((a.x-this.offsetX)/this._tileWidth),c=Math.floor((a.y-this.offsetY)/this._tileHeight);this.isHexagon&&0!=c%2&&(b=Math.floor((a.x-this.offsetX-0.5*this._tileWidth)/this._tileWidth));return cc.p(b,c)},getTiledPosition:function(a,b){var c=(a+0.5)*this._tileWidth+this.offsetX,d=(b+0.5)*this._tileHeight+this.offsetY;this.isHexagon&&0!=b%2&&(c+=0.5*this._tileWidth);return cc.p(c,
d)},getCoveredTiles:function(a,b){var c=flax.getRect(a,!0);return this.getCoveredTiles1(c,b)},getCoveredTiles1:function(a,b){b=!0===b;for(var c=this.getTileIndex(cc.p(a.x,a.y)),d=c.x,e=c.y,c=this.getTileIndex(cc.p(a.x+a.width,a.y+a.height)),f=c.x,c=c.y,g=[],d=d-1,h=0;++d<=f;)for(h=e-1;++h<=c;)b?g=g.concat(this.getObjects(d,h)):g.push(cc.p(d,h));return g},isValideTile:function(a,b){return 0<=a&&a<this._mapWidth&&0<=b&&b<this._mapHeight},snapToTile:function(a,b,c,d){if(a instanceof cc.Node){var e=null;
if(null==b||null==c)e=a.getPosition(),a.parent&&(e=a.parent.convertToWorldSpace(e)),c=this.getTileIndex(e),b=c.x,c=c.y;e=this.getTiledPosition(b,c);a.parent&&(e=a.parent.convertToNodeSpace(e));a.setPosition(e);!0===d&&a.setTileMap(this)}},snapAll:function(){for(var a=this._objectsArr.length,b=-1,c=null;++b<a;)c=this._objectsArr[b],this.snapToTile(c)},addObject:function(a,b,c){void 0===b&&(b=a.tx);void 0===c&&(c=a.ty);a.tx=b;a.ty=c;if(this.isValideTile(b,c)&&!(-1<this._objectsArr.indexOf(a))){this._objectsArr.push(a);
var d=this._objectsMap[b][c];!this._inUpdate&&cc.sys.isNative&&(this._inUpdate=!0,cc.director.getScheduler().scheduleUpdateForTarget(this));if(a instanceof cc.Node&&this.autoLayout){b=(b+(this._mapHeight-1-c)*this._mapWidth)*MAX_IN_TILE;c=null;for(var e=0,f=!1,g=0;g<d.length;g++)c=d[g],c instanceof cc.Node&&(!f&&c.y<=a.y&&(d.splice(g,0,a),a.zIndex=Math.min(e,MAX_IN_TILE)+b,f=!0,e++,g++),c.zIndex=Math.min(e,MAX_IN_TILE)+b,e++);f||(d.push(a),a.zOrder=Math.min(e,MAX_IN_TILE)+b)}else d.push(a)}},updateLayout:function(a,
b){if(this.isValideTile(a,b)){var c=this._objectsMap[a][b];if(0!=c.length){c.sort(this._sortByY);for(var d=null,e=0,f=0;f<c.length;f++)d=c[f],d instanceof cc.Node&&(d.zIndex=Math.min(e,MAX_IN_TILE)+zIndex0,e++)}}},removeObject:function(a,b,c){void 0===b&&(b=a.tx);void 0===c&&(c=a.ty);this.isValideTile(b,c)&&(b=this._objectsMap[b][c],c=b.indexOf(a),-1<c&&b.splice(c,1),c=this._objectsArr.indexOf(a),-1<c&&this._objectsArr.splice(c,1));this._inUpdate&&cc.sys.isNative&&0==this._objectsArr.length&&(this._inUpdate=
!1,cc.director.getScheduler().unscheduleUpdateForTarget(this))},removeObjects:function(a,b){if(this.isValideTile(a,b))for(var c=this._objectsMap[a][b],d=null,d=-1;c.length;)d=c[0],d.tx=d.ty=-1,d=this._objectsArr.indexOf(d),-1<d&&this._objectsArr.splice(d,1),c.splice(0,1)},getObjects:function(a,b){return this.isValideTile(a,b)?this._objectsMap[a][b]:[]},getObjects1:function(a,b){var c=this.getTileIndex(cc.p(a,b));return this.getObjects(c.x,c.y)},getAllObjects:function(){return this._objectsArr},getTiles:function(a){for(var b=
[],c=-1,d=-1;++c<this._mapWidth;)for(d=-1;++d<this._mapHeight;)null!=a&&!1===a(this,c,d)||b.push(cc.p(c,d));return b},getRow:function(a,b){for(var c=-1,d=[];++c<this._mapHeight;)d=!0===b?d.concat(this.getObjects(a,c)):d.push(cc.p(a,c));return d},getCol:function(a,b){for(var c=-1,d=[];++c<this._mapWidth;)d=!0===b?d.concat(this.getObjects(c,a)):d.push(cc.p(c,a));return d},__tilesSearched:null,__nonRecursive:!1,findConnectedObjects:function(a,b,c){this.__tilesSearched={};b=this.findNeighbors(a,b,c,null,
!1);a=b.indexOf(a);-1<a&&b.splice(a,1);this.__tilesSearched=null;return b},findNeighbors:function(a,b,c,d,e){for(var f=this._getAllDirections(a,c,d),g=!this.__nonRecursive&&null!=this.__tilesSearched,h=[],k=f.length;k--;){var m=EIGHT_DIRECTIONS_VALUE[f[k]],l=a.tx+m[0],m=a.ty+m[1];if(this.__tilesSearched){var q=l+"-"+m;if(!0===this.__tilesSearched[q])continue;this.__tilesSearched[q]=!0}if(e)h.push({x:l,y:m});else for(var l=this.getObjects(l,m),m=null,q=!1,v=0;v<l.length;v++)if(m=l[v],null==b||0==b.length||
m[b]===a[b])h.push(m),!q&&g&&(h=h.concat(this.findNeighbors(m,b,c,d,e)),q=!0)}return h},findSeparatedGroups:function(){var a=[],b=null;this.__tilesSearched={};var c=this.getAllObjects(),d=[],e=c.length;for(i=0;i<e;i++)nb=c[i],-1<d.indexOf(nb)||(b=this.findNeighbors(nb),b.length||!0===this.__tilesSearched[nb.tx+"-"+nb.ty]||(b=[nb],this.__tilesSearched[nb.tx+"-"+nb.ty]=!0),a.push(b),d=d.concat(b));this.__tilesSearched=null;return a},findSurroundings:function(a,b,c,d){if(null==b||1>b)b=1;a=[a];var e=
[];this.__tilesSearched={};for(this.__nonRecursive=!0;b--;){for(var f=[],g=0;g<a.length;g++){var h=a[g];void 0===h.tx&&(h={tx:h.x,ty:h.y});f=f.concat(this.findNeighbors(h,null,!0,null,c&&d?!c:!0))}a=f;if(c&&!d){for(var k=[],g=0;g<f.length;g++)h=f[g],k=k.concat(this.getObjects(h.x,h.y));e.push(k)}else e.push(f)}this.__tilesSearched=null;this.__nonRecursive=!1;return e},_getAllDirections:function(a,b,c){var d=ALL_DIRECTONS;this.isHexagon?d=0==a.ty%2?ALL_DIRECTONS0:ALL_DIRECTONS1:b||(d=d.slice(0,4));
a=ALL_DIRECTONS.indexOf(c);if(-1==a||3<a)return d;b=[];var e=null;for(a=0;a<d.length;a++)e=d[a],-1<e.indexOf(c)&&b.push(e);this.isHexagon&&1==b.length&&b.push("UP","DOWN");return b},isEmptyTile:function(a,b){if(!this.isValideTile(a,b))return!1;var c=this.getObjects(a,b);return c?0==c.length:!1},_sortByY:function(a,b){if(a.y>b.y)return-1;if(a.y<b.y)return 1}});flax.TileMap.create=function(a){return new flax.TileMap(a)};_p=flax.TileMap.prototype;cc.defineGetterSetter(_p,"tileSize",_p.getTileSize);
cc.defineGetterSetter(_p,"mapSize",_p.getMapSize);flax._tileMaps={};flax.getTileMap=function(a){if("undefined"!==typeof flax._tileMaps[a])return flax._tileMaps[a];cc.log("The tileMap: "+a+" hasn't been defined, pls use flax.registerTileMap to define it firstly!");return null};flax.registerTileMap=function(a){flax._tileMaps[a.id]=a};flax.userData={};flax.fetchUserData=function(a){var b=null;try{(b=cc.sys.localStorage.getItem(cc.game.config.gameId))&&(b=JSON.parse(b))}catch(c){cc.log("Fetch UserData Error: "+c.name)}b?flax.copyProperties(b,flax.userData):a&&(flax.userData=a);flax.userData||(flax.userData={})};flax.saveUserData=function(){flax.userData||(flax.userData={});try{cc.sys.localStorage.setItem(cc.game.config.gameId,JSON.stringify(flax.userData))}catch(a){cc.log("Save UserData Error: "+a.name)}};flax.ObjectPool=cc.Class.extend({maxCount:100,_clsName:null,_cls:null,_assetsFile:null,_pool:null,_extraID:"",init:function(a,b,c){if(this._assetsFile&&this._cls)return cc.log("The pool has been inited with cls: "+this._cls),!1;this._clsName=b;this._cls=flax.nameToObject(b);if(null==this._cls)return cc.log("There is no class named: "+b),!1;this._assetsFile=a;this._pool=[];void 0!==c&&(this.maxCount=c);return!0},fetch:function(a,b,c){if(null==a)return cc.log("Please give me a assetID to fetch a object!"),
null;var d=null;0<this._pool.length?(d=this._pool.shift(),d.__fromPool=!0,d.setSource(this._assetsFile,a)):d=this._cls.create?this._cls.create(this._assetsFile,a):new this._cls(this._assetsFile,a);d.__pool__id__=this._extraID;d.clsName=this._clsName;d.autoRecycle=!0;d.visible=!0;c?"undefined"===typeof c.zIndex&&(c.zIndex=0):c={zIndex:0};d.attr(c);b&&b.addChild(d);return d},recycle:function(a){a instanceof this._cls?this._pool.length<this.maxCount&&(a.onRecycle&&a.onRecycle(),a.retain&&a.retain(),
this._pool.push(a)):cc.log("The object to recycle is not the same type with this pool: "+this._cls)},release:function(){for(var a=this._pool.length;a--;)this._pool[a].release&&this._pool[a].release();this._pool.length=0}});flax.ObjectPool.all={};flax.ObjectPool.create=function(a,b,c){var d=new flax.ObjectPool;return d.init(a,b,c)?d:null};
flax.ObjectPool.get=function(a,b,c){null==b&&(b="flax.Animator");null==c&&(c="");var d=a+b+c,e=flax.ObjectPool.all[d];null==e&&(e=flax.ObjectPool.create(a,b),e._extraID=c,flax.ObjectPool.all[d]=e);return e};flax.ObjectPool.release=function(){for(var a in flax.ObjectPool.all)flax.ObjectPool.all[a].release(),delete flax.ObjectPool.all[a]};flax.HealthModule={maxHealth:100,health:100,hurtable:!0,dead:!1,ownerBody:null,onEnter:function(){this.health=this.maxHealth;this.dead=!1},onExit:function(){},onHit:function(a){if(!this.hurtable)return!1;if(this.dead)return!0;this.health-=a.damage;return 0>=this.health?(this.dead=!0,this.health=0,this.onDie(),!0):!1},onDie:function(){this.ownerBody?this.ownerBody.destroy():this.destroy()}};flax.EnemyWaveModule={waveAssetJson:null,waves:null,onWaveBegin:null,onEnemyIn:null,onWaveOver:null,batchCanvas:null,currentWave:-1,totalWaves:0,wavePaused:!0,waveOver:!1,_waveDefine:null,_enemyCount:0,_firstRun:!0,onEnter:function(){this.totalWaves=this.waves.length;this.onWaveBegin=new signals.Signal;this.onEnemyIn=new signals.Signal;this.onWaveOver=new signals.Signal;this.wavePaused||this.nextWave()},onExit:function(){this.onWaveBegin.removeAll();this.onEnemyIn.removeAll();this.onWaveOver.removeAll()},
startWave:function(){this.wavePaused&&(this.wavePaused=!1,this._firstRun?this.nextWave():this._createWaveEnemy(),this._firstRun=!1)},stopWave:function(){this.wavePaused||(this.wavePaused=!0)},nextWave:function(){this.waveOver||this.wavePaused||(this._enemyCount=0,this.currentWave++,this._waveDefine=this.waves[this.currentWave],this._createWaveEnemy(),this.onWaveBegin.dispatch())},_createWaveEnemy:function(){if(!this.waveOver&&!this.wavePaused){var a=flax.getRandomInArray(this._waveDefine.types),a=
this._doCreateEnemy(a);this.onEnemyIn.dispatch(a);++this._enemyCount<this._waveDefine.count?(a=flax.randInt(parseInt(this._waveDefine.interval[0]),parseInt(this._waveDefine.interval[1])),this.scheduleOnce(function(){this._createWaveEnemy()},a)):this.currentWave==this.totalWaves-1?(this.waveOver=!0,this.onWaveOver.dispatch()):this.nextWave()}},_doCreateEnemy:function(a){this.waveAssetJson&&flax.assetsManager.createDisplay(this.waveAssetJson,a,{parent:this.batchCanvas,x:this.x,y:this.y},!0)}};flax.GunParam=cc.Class.extend({bulletAssets:null,bulletID:null,targetMap:null,selfMap:null,damage:1,damageRadius:0,speed:600,interval:0.15,count:1,angleGap:5,angleOffset:0,waveInterval:0,countInWave:6,gravityX:0,gravityY:0,fireSound:null,fireEffectID:null,hitEffectID:null,alwaysLive:!1,bulletPlayOnce:!1,fps:0,isMissle:!1});flax.GunParam.create=function(a){var b=new flax.GunParam;0==a.speed&&(a.speed=0.001);flax.copyProperties(a,b);return b};
flax.Gun=cc.Node.extend({owner:null,param:null,aimTarget:null,_firing:!1,_targetMap:null,_canvas:null,start:function(){this._firing||(this._firing=!0,this._canvas=flax.BulletCanvas.fetch(this.param.bulletAssets),0>=this.param.waveInterval||1>this.param.countInWave?(this.schedule(this.shootOnce,this.param.interval),this.shootOnce()):this._waveFire())},end:function(){this._firing&&(this._firing=!1,this.unschedule(this.shootOnce),this.unschedule(this._createWave))},updateParam:function(a){null!=a&&(flax.copyProperties(a,
this.param),this.end(),this.start())},isFiring:function(){return this._firing},_waveFire:function(){this._firing&&(this._createWave(),this.schedule(this._createWave,this.param.interval*this.param.countInWave+this.param.waveInterval,cc.REPEAT_FOREVER))},shootOnce:function(){if(null!=this.parent){var a=this.parent.convertToWorldSpace(this.getPosition());if(this.aimTarget&&this.aimTarget.parent&&this.aimTarget.visible){var b=flax.getAngle(flax.getPosition(this,!0),this.aimTarget.center);this.owner.onAimingTarget(b);
this.rotation=b-this.param.angleOffset-this.parent.rotation}for(var a=this._canvas.convertToNodeSpace(a),b=flax.getRotation(this,!0),c=-1,d=0,e=0,f=flax.createDInts(this.param.count);++c<this.param.count;)e=f[c],d=b+e*this.param.angleGap,this._canvas.addBullet(d,a,this.param,this.owner);this._showFireEffect(a,d);this.param.fireSound&&flax.playSound(this.param.fireSound)}},_createWave:function(){1<this.param.countInWave?this.schedule(this.shootOnce,this.param.interval,this.param.countInWave-1):this.shootOnce()},
_showFireEffect:function(a,b){if(null!=this.param.fireEffectID&&""!=this.param.fireEffectID){var c=flax.assetsManager.createDisplay(this.param.bulletAssets,this.param.fireEffectID,{parent:this._canvas},!0);c.zIndex=999;c.autoDestroyWhenOver=!0;c.setPosition(a);c.setRotation(b);c.gotoAndPlay(0)}}});
flax.BulletCanvas=cc.SpriteBatchNode.extend({stageRect:null,assetsFile:null,onBulletHit:null,onBulletOut:null,_bullets:null,onEnter:function(){this._super();this._bullets=[];null==this.stageRect&&(this.stageRect=cc.rect(0,0,cc.visibleRect.width,cc.visibleRect.height));this.onBulletHit=new signals.Signal;this.onBulletOut=new signals.Signal;this.scheduleUpdate()},onExit:function(){this._super();this.onBulletHit.removeAll();this.onBulletOut.removeAll()},addBullet:function(a,b,c,d){if(null==this.parent)cc.log("Please create a bullet canvas: flax.BulletCanvas.create('"+
this.assetsFile+"', container, zIndex);");else{c instanceof flax.GunParam||(c=flax.GunParam.create(c));var e=flax.assetsManager.createDisplay(c.bulletAssets,c.bulletID,{parent:this},!0);e.owner=d;e.param=c;d&&d.targets&&(e.targets=d.targets);c.targetMap&&(e.targetMap=flax.getTileMap(c.targetMap));c.fps&&(e.fps=c.fps);e.__physicalShooted=!1;if(e instanceof flax.MovieClip){e.__isMovieClip=!0;e.autoPlayChildren=!0;e.autoDestroyWhenOver=!0;d=e.children.length;for(var f;d--;)f=e.children[d],c.selfMap&&
f.setTileMap(c.selfMap),f.__isBullet=!0,f.__canvas=this,f.__body=e}else c.selfMap&&(e.setTileMap(c.selfMap),e.__isBullet=!0,e.__canvas=this,e.__body=e);e.play();e.autoStopWhenOver=c.bulletPlayOnce;e.setPosition(b);e.setRotation(a);b=c.damage;b instanceof Array&&(1==b.length?b=b[0]:2<=b.length&&(b=flax.randInt(b[0],b[1])));e.damage=b;a=DEGREE_TO_RADIAN*(90-(a+c.angleOffset));e.__vx=c.speed*Math.cos(a);e.__vy=c.speed*Math.sin(a);this._bullets.push(e);return e}},destroyBullet:function(a,b,c){void 0===
b&&(b=this._bullets.indexOf(a));0>b||(!1!==c&&a.destroy(),this._bullets.splice(b,1))},update:function(a){var b=this._bullets.length;if(0!=b)for(var c=null,d=null,d=null,e=!1,e=null;b--;){c=this._bullets[b];c.physicsBody?c.__physicalShooted||(c.physicsBody.SetLinearVelocity({x:c.__vx/PTM_RATIO,y:c.__vy/PTM_RATIO}),c.__physicalShooted=!0):(c.__vx+=c.param.gravityX*a,c.__vy+=c.param.gravityY*a,c.x+=c.__vx*a,c.y+=c.__vy*a,c.rotation=flax.getAngle1(c.__vx,c.__vy,!0)-c.param.angleOffset);var d=flax.getRect(c,
!0),e=!1,f=!cc.rectIntersectsRect(this.stageRect,d);f||(d=this._checkHittedTarget(c,d,!1))&&d.length&&(e=flax.getPosition(c,!0),d=c.param.damageRadius,0<d&&(d=cc.rect(e.x-d/2,e.y-d/2,d,d),this._checkHittedTarget(c,d,!0)),e=!0);f?(this.onBulletOut.dispatch(c),this.destroyBullet(c,b)):e&&(this.onBulletHit.dispatch(c),c.param.alwaysLive||this.destroyBullet(c,b))}},_checkHittedTarget:function(a,b,c){var d=[],e=null;a.targets?e=a.targets:a.targetMap&&(e=a.targetMap.getCoveredTiles1(b,!0));if(!e||!e.length)return d;
b=flax.getRotation(a,!0);for(var f=-1;++f<e.length;)if((target=e[f])&&target.parent&&target.visible&&(!a.owner||!(target==a.owner||flax.isChildOf(a.owner,target)||!0===target.dead||null!=a.owner.camp&&target.camp==a.owner.camp)))if(a.__isMovieClip)for(var g=a.children,h=g.length;h--;){var k=g[h];b=flax.getRotation(k,!0);if(k.mainCollider.checkCollision(target.mainCollider)){flax.callModuleFunction(target,"onHit",a);!1!==target.hurtable&&this._showHitEffect(a,b,a.convertToWorldSpace(k.getPosition()));
target.__isBullet&&(k=target.__canvas._bullets.indexOf(target),-1<k&&target.__canvas._bullets.splice(k,1),target.__body.destroy());if(!c)return[target];d.push(target)}}else if(a.mainCollider.checkCollision(target.mainCollider)){flax.callModuleFuction(target,"onHit",a);!1!==target.hurtable&&this._showHitEffect(a,b,a.getPosition());target.__isBullet&&(k=target.__canvas._bullets.indexOf(target),-1<k&&target.__canvas._bullets.splice(k,1),target.__body.destroy());if(!c)return[target];d.push(target)}return d},
_showHitEffect:function(a,b,c){if(null!=a.param.hitEffectID&&""!=a.param.hitEffectID){var d=flax.assetsManager.createDisplay(a.param.bulletAssets,a.param.hitEffectID,{parent:this},!0);d.zIndex=999;d.autoDestroyWhenOver=!0;d.setPosition(c||a.getPosition());d.setRotation(b);d.gotoAndPlay(0)}}});flax.BulletCanvas.create=function(a,b,c){a=flax.BulletCanvas.fetch(a);a.parent!=b&&(a.removeFromParent(),b.addChild(a,c||999))};
flax.BulletCanvas.fetch=function(a){if(flax._bulletCanvases[a])return flax._bulletCanvases[a];var b=cc.path.changeBasename(a,".png"),b=new flax.BulletCanvas(b,100);b.assetsFile=a;return flax._bulletCanvases[a]=b};flax._bulletCanvases={};flax.BulletCanvas.release=function(){flax._bulletCanvases={}};flax.Gun.create=function(a){if(null==a)return cc.log("Please give me a param defiled like: flax.GunParam!"),null;a=flax.GunParam.create(a);var b=new flax.Gun;b.param=a;b.init();return b};flax._gunnerDefine={camp:null,_gunParam:null,targets:null,alwaysBind:!0,_guns:null,_autoShooting:!1,_waitingShoot:!1,_auto:!1,onEnter:function(){this._super();this._guns=[];this._gunParam&&this.setGunParam(this._gunParam)},onRecycle:function(){this._super();this._guns=this.targets=this._gunParam=this.camp=null;this._autoShooting=this._waitingShoot=this._auto=!1;this.stopShoot()},getGunParam:function(){return this._gunParam},setGunParam:function(a,b){this._gunParam=a;if(null!=this.parent)if(b||(b=
a.gunAnchors),null==b)cc.log("Please set the gunAnchors param!");else{for(var c=-1,d=b.length,e=null,f=null;++c<d;)e=b[c],f=flax.Gun.create(this._gunParam),this.bindAnchor(e,f,this.alwaysBind)&&(f.owner=this,f.name=e,this[e]=f,this._guns.push(f));this._waitingShoot&&this.scheduleOnce(this.autoShoot,0.1)}},shoot:function(){this._auto=!1;this._doBeginShoot()},autoShoot:function(a){this._auto=!0;null==this.parent||null==this._guns||0==this._guns.length?this._waitingShoot=!0:(0<a?this.scheduleOnce(this._doBeginShoot,
a):this._doBeginShoot(),this._autoShooting=!0,this._waitingShoot=!1)},aimToTarget:function(a){if(a&&a.parent&&a.visible){null==this.targets?this.targets=[a]:-1==this.targets.indexOf(a)&&this.targets.push(a);for(var b=-1,c=this._guns.length,d=null;++b<c;)d=this._guns[b],d.aimTarget=a}},onAimingTarget:function(a){},_doBeginShoot:function(){for(var a=-1,b=this._guns.length;++a<b;)this._auto?this._guns[a].start():this._guns[a].shootOnce()},stopShoot:function(){this._autoShooting=!1;if(null!=this._guns&&
0!=this._guns.length)for(var a=-1,b=this._guns.length;++a<b;)this._guns[a].end()},upgradeGun:function(a,b){var c=this._deltaGunParam(a);!isNaN(b)&&0<b?this.scheduleOnce(function(){this._deltaGunParam(c)},b):this._deltaGunParam(c)},_deltaGunParam:function(a){if(0!=this._guns.length){var b={},c=0,d;for(d in a)c=this._guns[0].param[d]+a[d],0>=c?delete a[d]:(b[d]=-a[d],a[d]=c);c=this._guns.length;for(d=null;c--;)d=this._guns[c],d.updateParam(a);return b}},onDie:function(){this.stopShoot();flax.callModuleFuction(this,
"onDie");this.ownerBody?this.ownerBody.destroy():this.destroy()}};flax.Gunner=flax.Animator.extend(flax._gunnerDefine);window.flax.Gunner=flax.Gunner;flax.MCGunner=flax.MovieClip.extend(flax._gunnerDefine);window.flax.MCGunner=flax.MCGunner;flax.addModule(flax.Gunner,flax.HealthModule,!1);flax.addModule(flax.MCGunner,flax.HealthModule,!1);_p=flax.Gunner.prototype;cc.defineGetterSetter(_p,"gunParam",_p.getGunParam,_p.setGunParam);_p=flax.MCGunner.prototype;
cc.defineGetterSetter(_p,"gunParam",_p.getGunParam,_p.setGunParam);flax.Gunner.create=function(a,b){var c=new flax.Gunner(a,b);c.clsName="flax.Gunner";return c};flax.MCGunner.create=function(a,b){var c=new flax.MCGunner(a,b);c.clsName="flax.MCGunner";return c};flax.ScrollingBG=cc.Node.extend({name:null,onScrolledOver:null,_loop:!0,_bg0:null,_bg1:null,_sources:null,_scrollingIndex:0,_scrolling:!1,_paused:!1,_speedX:0,_speedY:0,_d:1,_size:null,_x0:0,_y0:0,ctor:function(a,b,c){this._super();this._sources=[];this.onScrolledOver=new signals.Signal;a&&this.addSource(a,b,c)},onExit:function(){this._super();this.onScrolledOver.removeAll()},addSource:function(a,b,c){this._sources.push({source:a,assetID:b,isTile:c});null==this._bg0&&(this._bg0=this._createNextBG())},
_createNextBG:function(){this._scrollingIndex>this._sources.length-1&&(this._scrollingIndex=0);var a=this._sources[this._scrollingIndex];this._scrollingIndex++;var b=null;if(null!=a.assetID)b=!0!==a.isTile?flax.assetsManager.createDisplay(a.source,a.assetID,null,!0):new flax.TiledImage(a.source,a.assetID);else if(a.source)if(flax.isFlaxDisplay(a.source))a.source.parent&&a.source.parent.addChild(this,a.source.zIndex),this.name=a.source.name,this.parent&&(this.parent[this.name]=this),this.setPosition(a.source.getPosition()),
b=flax.assetsManager.cloneDisplay(a.source),a.source.destroy();else if(flax.isImageFile(a.source))b=cc.Sprite.create(a.source);else throw"Not supported source type!";else throw"Arguments is not valid!";b.setAnchorPoint(0,0);this.addChild(b);null==this._size&&(this._size=b.getContentSize(),this.setContentSize(this._size));return b},reset:function(){this._paused=!1;this._scrolling&&(this._scrolling=!1,this._speedX=this._speedY=0,this._bg0.destroy?this._bg0.destroy():this._bg0.removeFromParent(),this._bg0=
null,this._bg1.destroy?this._bg1.destroy():this._bg1.removeFromParent(),this._bg1=null,this._scrollingIndex=0,null==this._bg0&&(this._bg0=this._createNextBG()),this._bg0.setPosition(this._x0,this._y0),this.unscheduleUpdate())},startXScroll:function(a,b){0==a||null==this._bg0||this._scrolling||(this._scrolling=!0,this._loop=!1!==b,this._speedX=a,this._speedY=0,this._d=0<this._speedX?1:-1,this._resetScroll(),this.scheduleUpdate())},startYScroll:function(a,b){0==a||null==this._bg0||this._scrolling||
(this._scrolling=!0,this._loop=!1!==b,this._speedY=a,this._speedX=0,this._d=0<this._speedY?1:-1,this._resetScroll(),this.scheduleUpdate())},pauseScroll:function(){this._scrolling&&!this._paused&&(this._paused=!0,this.unscheduleUpdate())},resumeScroll:function(){this._scrolling&&this._paused&&(this._paused=!1,this.scheduleUpdate())},_resetScroll:function(){this._bg0.setPosition(this._x0,this._y0);null==this._bg1&&(this._bg1=this._createNextBG());0!=this._speedX?this._bg1.x=-this._d*(this._size.width-
1):this._bg1.y=-this._d*(this._size.height-1)},update:function(a){if(0==this._size.width*this._size.height)this._size=this._bg0.getContentSize(),0!=this._size.width*this._size.height&&(this.setContentSize(this._size),this._resetScroll());else{var b=!1;0!=this._speedX?(a*=this._speedX,this._bg0.x+=a,this._bg1.x+=a,a=this._size.width-this._bg0.x*this._d,0>=a&&(this._bg0.x+=this._d*a,this._bg1.x+=this._d*a,b=!0)):0!=this._speedY&&(a*=this._speedY,this._bg0.y+=a,this._bg1.y+=a,a=this._size.height-this._bg0.y*
this._d,0>=a&&(this._bg0.y+=this._d*a,this._bg1.y+=this._d*a,b=!0));b&&(!this._loop&&this._scrollingIndex>this._sources.length-1?(this.onScrolledOver.dispatch(),this.pauseScroll()):(this._bg0.destroy?this._bg0.destroy():this._bg0.removeFromParent(),this._bg0=this._bg1,this._bg1=this._createNextBG(),this._resetScroll()))}},getRect:function(){0==this._size.width*this._size.height&&(this._size=this._bg0.getContentSize(),0!=this._size.width*this._size.height&&this.setContentSize(this._size));return cc.rect(0,
0,this._size.width,this._size.height)}});flax.ScrollingBG.create=function(a,b,c){return new flax.ScrollingBG(a,b,c)};flax._scrollPaneDefine={_viewRect:null,onEnter:function(){this._super();(this._viewRect=this.getCollider("view").getRect(!0))?flax.inputManager.addListener(null,this._startDrag,InputType.press,this):cc.log("If you want me scrollable, please set collider__view for me!")},scrollToCenter:function(a,b){var c=cc.visibleRect.center,c=this.parent.convertToNodeSpace(c),d=this.convertToWorldSpace(a.getPosition?a.getPosition():a),d=this.parent.convertToNodeSpace(d),c=cc.pSub(c,d),c=this._validatePos(this.x+
c.x,this.y+c.y);0<b?this.runAction(cc.MoveTo.create(b,c)):this.setPosition(c)},_startDrag:function(a,b){this.scheduleOnce(function(){flax.inputManager.addListener(null,this._drag,InputType.move,this);flax.inputManager.addListener(null,this._stopDrag,InputType.up,this)},0.01)},_drag:function(a,b){var c=a.getDelta();this._viewRect.width>=this.width&&(c.x=0);this._viewRect.height>=this.height&&(c.y=0);c=this._validatePos(this.x+c.x,this.y+c.y);this.x=c.x;this.y=c.y},_stopDrag:function(a,b){flax.inputManager.removeListener(null,
this._drag,InputType.move);flax.inputManager.removeListener(null,this._stopDrag,InputType.up)},_validatePos:function(a,b){a=Math.max(this._viewRect.x+this._viewRect.width-this.width,a);a=Math.min(this._viewRect.x,a);b=Math.max(this._viewRect.y+this._viewRect.height-this.height,b);b=Math.min(this._viewRect.y,b);return cc.p(a,b)}};flax.ScrollPane=flax.Animator.extend(flax._scrollPaneDefine);flax.ScrollPane.create=function(a,b){return new flax.ScrollPane(a,b)};window.flax.ScrollPane=flax.ScrollPane;
flax.MCScrollPane=flax.MovieClip.extend(flax._scrollPaneDefine);flax.MCScrollPane.create=function(a,b){return new flax.MCScrollPane(a,b)};window.flax.MCScrollPane=flax.MCScrollPane;flax.TiledImage=cc.SpriteBatchNode.extend({tileMap:null,tileWidthOffset:0,tileHeightOffset:0,assetsFile:null,assetID:null,_mapWidth:0,_mapHeight:0,ctor:function(a,b,c,d){var e=cc.path.changeBasename(a,".png");cc.SpriteBatchNode.prototype.ctor.call(this,e);this.tileMap=new flax.TileMap;this.setTileSource(a,b);c||(c=cc.visibleRect.width);d||(d=cc.visibleRect.height);this.setSize(c,d)},setTileSource:function(a,b){if(this.assetsFile!=a||this.assetID!=b){this.assetsFile=a;this.assetID=b;var c=flax.assetsManager.createDisplay(this.assetsFile,
this.assetID).getContentSize();this.tileMap.setTileSize(c.width+this.tileWidthOffset,c.height+this.tileHeightOffset);0<this._mapWidth*this._mapHeight&&(0<this.getChildrenCount()&&this._updateTileImg(),this._updateSize())}},setSize:function(a,b){if(a!=this._mapWidth||b!=this._mapHeight)this._mapWidth=a,this._mapHeight=b,this.assetsFile&&this._updateSize()},_updateTileImg:function(){for(var a=null,b=this.getChildrenCount(),c=-1;++c<b;)a=this.children[c],a.setSource(this.assetsFile,this.assetID),this.tileMap.snapToTile(a,
a.tx,a.ty)},_updateSize:function(){var a=this.tileMap.setMapSizePixel(this._mapWidth,this._mapHeight),b,c=a[0].length;if(0<c){var d;for(b=-1;++b<c;)d=a[0][b],d.destroy?d.destroy():d.removeFromParent()}c=a[1].length;if(0<c)for(b=-1;++b<c;)this._createTile(a[1][b][0],a[1][b][1]);this.setContentSize(this.tileMap.getMapSizePixel())},_createTile:function(a,b){var c=flax.assetsManager.createDisplay(this.assetsFile,this.assetID,{parent:this},!0);c.setAnchorPoint(0.5,0.5);this.tileMap.snapToTile(c,a,b,!0);
return c}});EIGHT_DIRECT_VALUE=[[0,1],[0,-1],[-1,0],[1,0],[-1,1],[1,1],[1,-1],[-1,-1]];var LinkFinder={};window.LinkFinder=LinkFinder;LinkFinder.map=null;LinkFinder.blocks=null;LinkFinder.findLink=function(a,b,c,d){var e=null,e=a==c||b==d?LinkFinder._checkDirectLink(a,b,c,d):LinkFinder._checkOneLink(a,b,c,d);null==e&&(e=LinkFinder._checkTwoLink(a,b,c,d));return e};
LinkFinder.shuffle=function(a){var b=this.map.getAllObjects(),c=b.concat(),d=-1;if(this.blocks&&this.blocks.length)for(c=[];++d<b.length;){var e=b[d];-1==this.blocks.indexOf(e)&&c.push(e)}flax.shuffleArray(c);d=-1;for(b=c.length/2;++d<b;){var e=c[d],f=c[d+b],g=cc.p(e.getPosition());!1!==a?(e.runAction(cc.MoveTo.create(0.2,f.getPosition())),f.runAction(cc.MoveTo.create(0.2,g))):(e.setPosition(f.getPosition()),f.setPosition(g))}};
LinkFinder.findAvailableLink=function(a){var b=this.map.getAllObjects(),c=b.length;if(0==c)return null;for(var d,e,f=null,g=[],h=null,k=0;k<c-1;k++)if(d=b[k],!(this.blocks&&-1<this.blocks.indexOf(d))){var m=0==g.length;null==h&&(h=d);for(var l=k+1;l<c;l++)if(e=b[l],!(this.blocks&&-1<this.blocks.indexOf(e)))if(e.assetID==d.assetID){if(LinkFinder.findLink(d.tx,d.ty,e.tx,e.ty))return[d,e];m&&g.push(e)}else m&&null==f&&LinkFinder.findLink(d.tx,d.ty,e.tx,e.ty)&&(f=e)}if(0==g.length)return null;b=g[Math.floor(g.length*
Math.random())];c=cc.p(b.getPosition());if(null==f){f=this._findEmptyNeighbor(h.tx,h.ty);if(null==f)throw"Dead map!!!!";c=this.map.getTiledPosition(f.x,f.y);b.parent&&(c=b.parent.convertToNodeSpace(c));!0===a?b.runAction(cc.MoveTo.create(0.2,c)):b.setPosition(c)}else!0===a?(b.runAction(cc.MoveTo.create(0.2,f.getPosition())),f.runAction(cc.MoveTo.create(0.2,c))):(b.setPosition(f.getPosition()),f.setPosition(c));return[h,b]};
LinkFinder._findEmptyNeighbor=function(a,b){for(var c=null,d=0;4>d&&(c=EIGHT_DIRECT_VALUE[d],c=cc.p(a+c[0],b+c[1]),!this.map.isEmptyTile(c.x,c.y));d++);return c};LinkFinder._checkDirectLink=function(a,b,c,d){if(a==c&&b==d)return null;if(a==c){for(var e=!0,f=0<d-b?1:-1,g=b+f;g!=d;){if(!this.map.isEmptyTile(a,g)){e=!1;break}g+=f}if(e)return[new cc.p(a,b),new cc.p(c,d)]}if(b==d){e=!0;f=0<c-a?1:-1;for(g=a+f;g!=c;){if(!this.map.isEmptyTile(g,b)){e=!1;break}g+=f}if(e)return[new cc.p(a,b),new cc.p(c,d)]}return null};
LinkFinder._checkOneLink=function(a,b,c,d){if(a==c||b==d)return null;if(this.map.isEmptyTile(a,d)){var e=LinkFinder._checkDirectLink(a,b,a,d);if(e&&(e=LinkFinder._checkDirectLink(a,d,c,d)))return[new cc.p(a,b),new cc.p(a,d),new cc.p(c,d)]}return this.map.isEmptyTile(c,b)&&(e=LinkFinder._checkDirectLink(a,b,c,b))&&(e=LinkFinder._checkDirectLink(c,b,c,d))?[new cc.p(a,b),new cc.p(c,b),new cc.p(c,d)]:null};
LinkFinder._checkTwoLink=function(a,b,c,d){if(a==c&&b==d)return null;var e=0<=c-a?1:-1,f=0<=d-b?1:-1,g=LinkFinder._twoLinkSearch(a,b,c,d,e,f);null==g&&(g=LinkFinder._twoLinkSearch(a,b,c,d,-e,-f));null!=g&&g.unshift(new cc.p(a,b));return g};
LinkFinder._twoLinkSearch=function(a,b,c,d,e,f){for(var g=null,h=a+e,k=b+f,m=!1,l=!1;!m||!l;){if(!m&&(m=!this.map.isEmptyTile(h,b),!m)){g=LinkFinder._checkOneLink(h,b,c,d);if(null!=g)break;h+=e}if(!l&&(l=!this.map.isEmptyTile(a,k),!l)){g=LinkFinder._checkOneLink(a,k,c,d);if(null!=g)break;k+=f}}return g};